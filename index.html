<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BETA SMART FINANCE PRO v2.0 - نظام التقسيط المرن المتطور</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap');
        * { 
            font-family: 'Cairo', sans-serif;
            box-sizing: border-box;
        }
        body { 
            margin: 0; 
            padding: 0;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            min-height: 100vh;
        }
        
        @media print {
            body { 
                print-color-adjust: exact; 
                -webkit-print-color-adjust: exact; 
                margin: 0;
                padding: 0;
                background: white !important;
            }
            .print-hidden { display: none !important; }
            .print-only { display: block !important; }
            .print-container { 
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 20mm !important;
                background: white !important;
            }
            @page {
                size: A4;
                margin: 15mm;
            }
            .glass-card {
                background: white !important;
                border: 1px solid #ccc !important;
            }
        }
        
        .print-only { display: none; }
        
        /* Modern Glassmorphism Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .glass-dark {
            background: rgba(99, 102, 241, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        
        /* Premium Gradient Backgrounds - BETA Corporate Colors */
        .gradient-primary {
            background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
        }
        
        .gradient-info {
            background: linear-gradient(135deg, #DC143C 0%, #A52A2A 100%);
        }
        
        .gradient-warning {
            background: linear-gradient(135deg, #DC143C 0%, #FF6347 100%);
        }
        
        .gradient-dark {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }
        
        /* Modern Input Styles */
        .modern-input {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }
        
        .modern-input:focus {
            border-color: #DC143C;
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.15);
            transform: translateY(-2px);
        }
        
        .modern-input:hover {
            border-color: #FF6B6B;
        }
        
        /* Premium Button Styles */
        .btn-premium {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .btn-premium::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-premium:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* Modern Badge Styles */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-pro {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .badge-new {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%);
            border-radius: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slide-in { animation: slideIn 0.4s ease-out; }

        .comparison-table td, .comparison-table th {
            padding: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .comparison-highlight-positive {
            background-color: #d1fae5;
            font-weight: bold;
        }
        
        .comparison-highlight-negative {
            background-color: #fee2e2;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ═══════════════════════════════════════════════════════════════
        // SQLITE DATABASE MANAGER - Persistent Storage Layer
        // ═══════════════════════════════════════════════════════════════

        class BetaDatabase {
            constructor() {
                this.db = null;
                this.ready = false;
                this.DB_STORAGE_KEY = 'betaFinanceDB_sqlite';
            }

            async init() {
                try {
                    const SQL = await initSqlJs({
                        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
                    });

                    // Try to load existing DB from localStorage
                    const savedDB = localStorage.getItem(this.DB_STORAGE_KEY);
                    if (savedDB) {
                        try {
                            const binaryArray = new Uint8Array(atob(savedDB).split('').map(c => c.charCodeAt(0)));
                            this.db = new SQL.Database(binaryArray);
                            console.log('✅ SQLite: Loaded existing database');
                        } catch (e) {
                            console.warn('⚠️ SQLite: Corrupt saved DB, creating new one', e);
                            this.db = new SQL.Database();
                            this._createTables();
                        }
                    } else {
                        this.db = new SQL.Database();
                        this._createTables();
                        // Migrate from old localStorage if exists
                        this._migrateFromLocalStorage();
                        console.log('✅ SQLite: Created new database');
                    }

                    this.ready = true;
                    this._persist();
                    return true;
                } catch (err) {
                    console.error('❌ SQLite init failed:', err);
                    return false;
                }
            }

            _createTables() {
                this.db.run(`
                    CREATE TABLE IF NOT EXISTS projects (
                        id INTEGER PRIMARY KEY,
                        name TEXT NOT NULL,
                        cashDiscountRate REAL DEFAULT 30,
                        discountRate REAL DEFAULT 14,
                        discountRateMode TEXT DEFAULT 'manual',
                        minDownPaymentPercent REAL DEFAULT 5,
                        maxInstallmentYears INTEGER DEFAULT 8,
                        baseSystem TEXT DEFAULT '{}',
                        description TEXT DEFAULT '',
                        color TEXT DEFAULT 'indigo',
                        created_at TEXT DEFAULT (datetime('now')),
                        updated_at TEXT DEFAULT (datetime('now'))
                    )
                `);

                this.db.run(`
                    CREATE TABLE IF NOT EXISTS calculation_history (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        project_id INTEGER,
                        unit_value REAL,
                        unit_number TEXT,
                        pattern TEXT,
                        frequency INTEGER,
                        down_payment REAL,
                        number_of_years INTEGER,
                        total_paid REAL,
                        total_pv REAL,
                        schedule TEXT,
                        verification TEXT,
                        created_at TEXT DEFAULT (datetime('now')),
                        FOREIGN KEY (project_id) REFERENCES projects(id)
                    )
                `);

                this.db.run(`
                    CREATE TABLE IF NOT EXISTS settings (
                        key TEXT PRIMARY KEY,
                        value TEXT,
                        updated_at TEXT DEFAULT (datetime('now'))
                    )
                `);
            }

            _migrateFromLocalStorage() {
                try {
                    const oldData = localStorage.getItem('betaProjects_v2_9');
                    if (oldData) {
                        const projects = JSON.parse(oldData);
                        projects.forEach(p => this.saveProject(p));
                        console.log(`✅ SQLite: Migrated ${projects.length} projects from localStorage`);
                    }
                } catch (e) {
                    console.warn('⚠️ Migration from localStorage failed:', e);
                }
            }

            _persist() {
                if (!this.db) return;
                try {
                    const data = this.db.export();
                    const base64 = btoa(String.fromCharCode.apply(null, data));
                    localStorage.setItem(this.DB_STORAGE_KEY, base64);
                } catch (e) {
                    console.error('❌ SQLite persist failed:', e);
                }
            }

            // ═══ PROJECTS CRUD ═══

            getAllProjects() {
                if (!this.db) return [];
                try {
                    const results = this.db.exec("SELECT * FROM projects ORDER BY id");
                    if (!results.length) return [];
                    return results[0].values.map(row => {
                        const cols = results[0].columns;
                        const obj = {};
                        cols.forEach((c, i) => obj[c] = row[i]);
                        obj.baseSystem = JSON.parse(obj.baseSystem || '{}');
                        return obj;
                    });
                } catch (e) {
                    console.error('❌ getAllProjects error:', e);
                    return [];
                }
            }

            saveProject(project) {
                if (!this.db) return false;
                try {
                    const existing = this.db.exec("SELECT id FROM projects WHERE id = ?", [project.id]);
                    const baseSystemJSON = JSON.stringify(project.baseSystem || {});

                    if (existing.length > 0 && existing[0].values.length > 0) {
                        this.db.run(`UPDATE projects SET 
                            name=?, cashDiscountRate=?, discountRate=?, discountRateMode=?,
                            minDownPaymentPercent=?, maxInstallmentYears=?, baseSystem=?,
                            description=?, color=?, updated_at=datetime('now')
                            WHERE id=?`,
                            [project.name, project.cashDiscountRate, project.discountRate,
                             project.discountRateMode, project.minDownPaymentPercent,
                             project.maxInstallmentYears, baseSystemJSON,
                             project.description, project.color, project.id]);
                    } else {
                        this.db.run(`INSERT INTO projects 
                            (id, name, cashDiscountRate, discountRate, discountRateMode,
                             minDownPaymentPercent, maxInstallmentYears, baseSystem, description, color)
                            VALUES (?,?,?,?,?,?,?,?,?,?)`,
                            [project.id, project.name, project.cashDiscountRate, project.discountRate,
                             project.discountRateMode, project.minDownPaymentPercent,
                             project.maxInstallmentYears, baseSystemJSON,
                             project.description, project.color]);
                    }
                    this._persist();
                    return true;
                } catch (e) {
                    console.error('❌ saveProject error:', e);
                    return false;
                }
            }

            deleteProject(projectId) {
                if (!this.db) return false;
                try {
                    this.db.run("DELETE FROM projects WHERE id = ?", [projectId]);
                    this._persist();
                    return true;
                } catch (e) {
                    console.error('❌ deleteProject error:', e);
                    return false;
                }
            }

            // ═══ CALCULATION HISTORY ═══

            saveCalculation(calcData) {
                if (!this.db) return false;
                try {
                    this.db.run(`INSERT INTO calculation_history 
                        (project_id, unit_value, unit_number, pattern, frequency,
                         down_payment, number_of_years, total_paid, total_pv, schedule, verification)
                        VALUES (?,?,?,?,?,?,?,?,?,?,?)`,
                        [calcData.projectId, calcData.unitValue, calcData.unitNumber || '',
                         calcData.pattern, calcData.frequency, calcData.downPayment,
                         calcData.numberOfYears, calcData.totalPaid, calcData.totalPV,
                         JSON.stringify(calcData.schedule || []),
                         JSON.stringify(calcData.verification || {})]);
                    this._persist();
                    return true;
                } catch (e) {
                    console.error('❌ saveCalculation error:', e);
                    return false;
                }
            }

            getCalculationHistory(projectId = null, limit = 50) {
                if (!this.db) return [];
                try {
                    let query = "SELECT * FROM calculation_history";
                    let params = [];
                    if (projectId) {
                        query += " WHERE project_id = ?";
                        params.push(projectId);
                    }
                    query += " ORDER BY created_at DESC LIMIT ?";
                    params.push(limit);

                    const results = this.db.exec(query, params);
                    if (!results.length) return [];
                    return results[0].values.map(row => {
                        const cols = results[0].columns;
                        const obj = {};
                        cols.forEach((c, i) => obj[c] = row[i]);
                        obj.schedule = JSON.parse(obj.schedule || '[]');
                        obj.verification = JSON.parse(obj.verification || '{}');
                        return obj;
                    });
                } catch (e) {
                    console.error('❌ getHistory error:', e);
                    return [];
                }
            }

            deleteCalculation(calcId) {
                if (!this.db) return false;
                try {
                    this.db.run("DELETE FROM calculation_history WHERE id = ?", [calcId]);
                    this._persist();
                    return true;
                } catch (e) { return false; }
            }

            clearHistory() {
                if (!this.db) return false;
                try {
                    this.db.run("DELETE FROM calculation_history");
                    this._persist();
                    return true;
                } catch (e) { return false; }
            }

            // ═══ SETTINGS ═══

            getSetting(key, defaultVal = null) {
                if (!this.db) return defaultVal;
                try {
                    const r = this.db.exec("SELECT value FROM settings WHERE key = ?", [key]);
                    return (r.length && r[0].values.length) ? r[0].values[0][0] : defaultVal;
                } catch (e) { return defaultVal; }
            }

            setSetting(key, value) {
                if (!this.db) return false;
                try {
                    this.db.run(`INSERT OR REPLACE INTO settings (key, value, updated_at) VALUES (?, ?, datetime('now'))`, [key, value]);
                    this._persist();
                    return true;
                } catch (e) { return false; }
            }

            // ═══ EXPORT / IMPORT ═══

            exportDatabase() {
                if (!this.db) return null;
                const data = this.db.export();
                const blob = new Blob([data], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `beta_finance_backup_${new Date().toISOString().slice(0,10)}.sqlite`;
                a.click();
                URL.revokeObjectURL(url);
                return true;
            }

            async importDatabase(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const SQL = this.db.constructor;
                            const arr = new Uint8Array(e.target.result);
                            // Validate it's a real SQLite file
                            const testDb = new SQL.prototype.constructor.Database ? null : null;
                            initSqlJs({
                                locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${f}`
                            }).then(SQL => {
                                const newDb = new SQL.Database(arr);
                                // Verify tables exist
                                const tables = newDb.exec("SELECT name FROM sqlite_master WHERE type='table'");
                                const tableNames = tables.length ? tables[0].values.map(r => r[0]) : [];
                                if (!tableNames.includes('projects')) {
                                    reject(new Error('ملف قاعدة بيانات غير صالح - لا يحتوي على جدول المشاريع'));
                                    return;
                                }
                                this.db = newDb;
                                this._persist();
                                resolve(true);
                            });
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = () => reject(new Error('فشل قراءة الملف'));
                    reader.readAsArrayBuffer(file);
                });
            }

            // ═══ STATS ═══

            getStats() {
                if (!this.db) return {};
                try {
                    const projCount = this.db.exec("SELECT COUNT(*) FROM projects");
                    const calcCount = this.db.exec("SELECT COUNT(*) FROM calculation_history");
                    const lastCalc = this.db.exec("SELECT created_at FROM calculation_history ORDER BY created_at DESC LIMIT 1");
                    return {
                        projectCount: projCount[0]?.values[0][0] || 0,
                        calculationCount: calcCount[0]?.values[0][0] || 0,
                        lastCalculation: lastCalc[0]?.values[0]?.[0] || 'لا يوجد'
                    };
                } catch (e) { return {}; }
            }
        }

        // Global DB instance
        const betaDB = new BetaDatabase();

        // ═══════════════════════════════════════════════════════════════
        // BETA SMART FINANCE ENGINE - FLEXIBLE PAYMENT SYSTEM
        // ═══════════════════════════════════════════════════════════════
        
        class SmartPaymentEngine {
            constructor(unitValue, cashDiscountRate, discountRate, baseDate = new Date()) {
                this.unitValue = unitValue;
                this.cashDiscountRate = cashDiscountRate / 100;
                this.discountRate = discountRate / 100;
                this.cashValue = unitValue * (1 - this.cashDiscountRate);
                this.baseDate = new Date(baseDate);
                this.baseDate.setHours(0, 0, 0, 0);
            }

            // ═══ XNPV IMPLEMENTATION ═══
            calculateXNPV(rate, cashFlows) {
                if (cashFlows.length === 0) return 0;
                
                return cashFlows.reduce((npv, cf) => {
                    const cfDate = new Date(cf.date);
                    cfDate.setHours(0, 0, 0, 0);
                    
                    const days = Math.round((cfDate - this.baseDate) / (1000 * 60 * 60 * 24));
                    const years = days / 365;
                    
                    if (days <= 0) {
                        return npv + cf.amount;
                    }
                    
                    return npv + cf.amount / Math.pow(1 + rate, years);
                }, 0);
            }

            calculatePVWithDate(amount, paymentDate) {
                const payment = new Date(paymentDate);
                payment.setHours(0, 0, 0, 0);
                const days = Math.round((payment - this.baseDate) / (1000 * 60 * 60 * 24));
                const years = days / 365;
                
                if (days <= 0) {
                    return amount;
                }
                
                return amount / Math.pow(1 + this.discountRate, years);
            }

            addMonths(date, months) {
                const d = new Date(date);
                d.setMonth(d.getMonth() + months);
                return d;
            }

            // دالة إضافة أشهر مع ضبط اليوم على 1 أو 15 بشكل دقيق
            addMonthsWithDay(date, months, day) {
                const d = new Date(date);
                // نحسب الشهر والسنة الجديدة
                let newMonth = d.getMonth() + months;
                let newYear = d.getFullYear();
                
                // معالجة تجاوز الأشهر
                while (newMonth > 11) {
                    newMonth -= 12;
                    newYear++;
                }
                while (newMonth < 0) {
                    newMonth += 12;
                    newYear--;
                }
                
                // إنشاء تاريخ جديد مع ضبط الوقت على الظهر لتجنب مشاكل timezone
                const result = new Date(newYear, newMonth, day, 12, 0, 0);
                
                return result;
            }
            
            // دالة تنسيق التاريخ بشكل صحيح (تجنب مشاكل timezone)
            formatDateLocal(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // ═══ PV using effective periodic rate (Excel-compatible) ═══
            // period = 1-based index (1st installment, 2nd, etc.)
            calculatePVPeriodic(amount, period, frequency) {
                const r_periodic = Math.pow(1 + this.discountRate, 1 / frequency) - 1;
                return amount / Math.pow(1 + r_periodic, period);
            }

            // ═══ FIND EQUAL INSTALLMENT ═══
            // Uses effective periodic rate annuity formula (Excel PMT-compatible)
            findEqualInstallmentXNPV(targetPV, dates, frequency) {
                // Standard annuity formula: PMT = PV × r / (1 - (1+r)^-n)
                // Uses effective periodic rate: r = (1 + annual_rate)^(1/freq) - 1
                if (frequency && frequency > 0 && dates.length > 0) {
                    const n = dates.length;
                    const r_periodic = Math.pow(1 + this.discountRate, 1 / frequency) - 1;
                    
                    if (r_periodic > 0) {
                        const pmt = targetPV * r_periodic / (1 - Math.pow(1 + r_periodic, -n));
                        if (isFinite(pmt) && pmt > 0) {
                            return pmt;
                        }
                    }
                }
                
                // Fallback: binary search
                let low = 0, high = targetPV * 2, tolerance = 0.01;
                const maxIterations = 200;
                let iterations = 0;

                while (high - low > tolerance && iterations < maxIterations) {
                    const mid = (low + high) / 2;
                    
                    let calculatedPV = 0;
                    for (let i = 0; i < dates.length; i++) {
                        calculatedPV += this.calculatePVWithDate(mid, dates[i]);
                    }
                    
                    if (calculatedPV < targetPV) {
                        low = mid;
                    } else {
                        high = mid;
                    }
                    
                    iterations++;
                }
                
                return (low + high) / 2;
            }

            // ═══ EQUAL INSTALLMENTS ═══
            calculateEqualInstallments(params) {
                const {
                    downPayment,
                    downPaymentDate,
                    numberOfYears,
                    frequency = 4,
                    annualPayments = [],
                    semiannualPayments = [],
                    quarterlyPayments = [],
                    quarterlyStartDate = null,
                    installmentDay = 1, // يوم استحقاق القسط (1 أو 15)
                    distributeUnitValue = false // توزيع سعر الوحدة بدل Cash Value
                } = params;
                
                const basePaymentDate = downPaymentDate || this.baseDate;
                
                let knownPV = downPayment;
                let knownAmount = downPayment; // للتوزيع المباشر
                const schedule = [{
                    id: 0,
                    type: 'مقدم',
                    date: this.formatDateLocal(basePaymentDate),
                    amount: downPayment,
                    pv: downPayment,
                    discount: 0
                }];

                let paymentId = 1;

                // معالجة الدفعات السنوية
                annualPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(basePaymentDate, (index + 1) * 12, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    knownAmount += amount;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `دفعة سنوية ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                // معالجة الدفعات النصف سنوية
                semiannualPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(basePaymentDate, (index + 1) * 6, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    knownAmount += amount;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `دفعة نصف سنوية ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                // معالجة الدفعات الربع سنوية (المحددة)
                quarterlyPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(basePaymentDate, (index + 1) * 3, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    knownAmount += amount;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `دفعة ربع سنوية ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                let remainingPV, installmentAmount;

                if (distributeUnitValue) {
                    // ═══ توزيع سعر الوحدة: الإجمالي المدفوع = سعر الوحدة ═══
                    const remainingAmount = this.unitValue - knownAmount;
                    if (remainingAmount <= 0) {
                        throw new Error(`⚠️ الدفعات المعروفة تتجاوز سعر الوحدة.`);
                    }
                    remainingPV = this.cashValue - knownPV; // for reference only
                    
                    const monthsInterval = 12 / frequency;
                    let startDate;
                    if (quarterlyStartDate) {
                        const tempDate = new Date(quarterlyStartDate);
                        startDate = new Date(tempDate.getFullYear(), tempDate.getMonth(), installmentDay, 12, 0, 0);
                    } else {
                        startDate = this.addMonthsWithDay(basePaymentDate, monthsInterval, installmentDay);
                    }
                    
                    const numberOfQuarters = numberOfYears * frequency;
                    const quarterlyDates = [];
                    for (let i = 0; i < numberOfQuarters; i++) {
                        quarterlyDates.push(this.addMonthsWithDay(startDate, i * (12 / frequency), installmentDay));
                    }

                    installmentAmount = remainingAmount / numberOfQuarters;

                    quarterlyDates.forEach((date, index) => {
                        const pv = this.calculatePVPeriodic(installmentAmount, index + 1, frequency);
                        schedule.push({
                            id: paymentId++,
                            type: `قسط موحد ${index + 1}`,
                            date: this.formatDateLocal(date),
                            amount: installmentAmount,
                            pv,
                            discount: installmentAmount - pv
                        });
                    });

                } else {
                    // ═══ حساب PV-based (الأسلوب القياسي) ═══
                    remainingPV = this.cashValue - knownPV;
                
                    if (remainingPV <= 0) {
                        throw new Error(`⚠️ الدفعات المعروفة (${knownPV.toLocaleString('ar-EG')} ج) تتجاوز قيمة الكاش (${this.cashValue.toLocaleString('ar-EG')} ج). يرجى تقليل المقدم أو الدفعات الإضافية.`);
                    }
                
                    const monthsInterval = 12 / frequency;
                
                    let startDate;
                    if (quarterlyStartDate) {
                        const tempDate = new Date(quarterlyStartDate);
                        startDate = new Date(tempDate.getFullYear(), tempDate.getMonth(), installmentDay, 12, 0, 0);
                    } else {
                        startDate = this.addMonthsWithDay(basePaymentDate, monthsInterval, installmentDay);
                    }
                
                    const numberOfQuarters = numberOfYears * frequency;
                    const quarterlyDates = [];
                    for (let i = 0; i < numberOfQuarters; i++) {
                        quarterlyDates.push(this.addMonthsWithDay(startDate, i * (12 / frequency), installmentDay));
                    }

                    installmentAmount = this.findEqualInstallmentXNPV(remainingPV, quarterlyDates, frequency);

                    quarterlyDates.forEach((date, index) => {
                        const pv = this.calculatePVPeriodic(installmentAmount, index + 1, frequency);
                        schedule.push({
                            id: paymentId++,
                            type: `قسط موحد ${index + 1}`,
                            date: this.formatDateLocal(date),
                            amount: installmentAmount,
                            pv,
                            discount: installmentAmount - pv
                        });
                    });
                }

                const verification = this.verifyScheduleXNPV(schedule, frequency);

                const numberOfInstallments = numberOfYears * frequency;
                return {
                    pattern: 'equal',
                    patternName: 'نظام القسط الموحد',
                    downPayment,
                    installmentAmount,
                    numberOfInstallments,
                    annualPayments: annualPayments.length,
                    semiannualPayments: semiannualPayments.length,
                    quarterlyPayments: quarterlyPayments.length,
                    frequency,
                    distributeUnitValue,
                    schedule,
                    verification,
                    summary: this.calculateSummary(schedule)
                };
            }

            // ═══ DECREASING PAYMENTS ═══
            calculateDecreasingPayments(params) {
                const {
                    downPayment,
                    numberOfYears,
                    frequency = 4,
                    decreaseRate = 2,
                    annualPayments = [],
                    semiannualPayments = [],
                    quarterlyPayments = [],
                    quarterlyStartDate = null,
                    installmentDay = 1
                } = params;

                let knownPV = downPayment;
                const schedule = [{
                    id: 0,
                    type: 'مقدم',
                    date: this.formatDateLocal(this.baseDate),
                    amount: downPayment,
                    pv: downPayment,
                    discount: 0
                }];

                let paymentId = 1;

                annualPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(this.baseDate, (index + 1) * 12, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `دفعة سنوية ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                semiannualPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(this.baseDate, (index + 1) * 6, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `دفعة نصف سنوية ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                // معالجة الدفعات الربع سنوية (المحددة)
                quarterlyPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(this.baseDate, (index + 1) * 3, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `دفعة ربع سنوية ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                const remainingPV = this.cashValue - knownPV;
                // حساب الفترة الزمنية بين الأقساط بالشهور
                const monthsInterval = 12 / frequency; // ✅ التصحيح

                let startDate;
                if (quarterlyStartDate) {
                    const tempDate = new Date(quarterlyStartDate);
                    startDate = new Date(tempDate.getFullYear(), tempDate.getMonth(), installmentDay, 12, 0, 0);
                } else {
                    startDate = this.addMonthsWithDay(this.baseDate, monthsInterval, installmentDay); // ✅ استخدام المتغير
                }
                
                const numberOfQuarters = numberOfYears * frequency;
                const quarterlyDates = [];
                for (let i = 0; i < numberOfQuarters; i++) {
                    quarterlyDates.push(this.addMonthsWithDay(startDate, i * (12 / frequency), installmentDay));
                }

                const baseInstallment = this.findBaseInstallmentDecreasing(remainingPV, quarterlyDates, decreaseRate / 100);

                // حماية: التحقق من أن القسط الأساسي موجب
                if (remainingPV <= 0 || baseInstallment <= 0) {
                    throw new Error(`⚠️ الدفعات المعروفة تتجاوز قيمة الكاش. يرجى تقليل المقدم أو الدفعات الإضافية.`);
                }

                quarterlyDates.forEach((date, index) => {
                    const amount = baseInstallment * Math.pow(1 - decreaseRate / 100, index);
                    const pv = this.calculatePVWithDate(amount, date);
                    schedule.push({
                        id: paymentId++,
                        type: `قسط متناقص ${index + 1}`,
                        date: this.formatDateLocal(date),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                const verification = this.verifyScheduleXNPV(schedule);

                return {
                    pattern: 'decreasing',
                    patternName: 'نظام الأقساط المتناقصة',
                    downPayment,
                    baseInstallment,
                    decreaseRate,
                    numberOfInstallments: quarterlyDates.length,
                    annualPayments: annualPayments.length,
                    semiannualPayments: semiannualPayments.length,
                    quarterlyPayments: quarterlyPayments.length,
                    frequency,
                    schedule,
                    verification,
                    summary: this.calculateSummary(schedule)
                };
            }

            findBaseInstallmentDecreasing(targetPV, dates, decreaseRate) {
                let low = 0, high = targetPV * 2, tolerance = 0.01;
                const maxIterations = 200;
                let iterations = 0;

                while (high - low > tolerance && iterations < maxIterations) {
                    const mid = (low + high) / 2;
                    
                    let calculatedPV = 0;
                    for (let i = 0; i < dates.length; i++) {
                        const amount = mid * Math.pow(1 - decreaseRate, i);
                        calculatedPV += this.calculatePVWithDate(amount, dates[i]);
                    }
                    
                    if (calculatedPV < targetPV) {
                        low = mid;
                    } else {
                        high = mid;
                    }
                    
                    iterations++;
                }
                
                return (low + high) / 2;
            }

            // ═══ GRADUATED PAYMENTS ═══
            calculateGraduatedPayments(params) {
                const {
                    downPayment,
                    numberOfYears,
                    frequency = 4,
                    growthRate = 3,
                    annualPayments = [],
                    semiannualPayments = [],
                    quarterlyPayments = [],
                    quarterlyStartDate = null,
                    installmentDay = 1
                } = params;

                let knownPV = downPayment;
                const schedule = [{
                    id: 0,
                    type: 'مقدم',
                    date: this.formatDateLocal(this.baseDate),
                    amount: downPayment,
                    pv: downPayment,
                    discount: 0
                }];

                let paymentId = 1;

                annualPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(this.baseDate, (index + 1) * 12, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `دفعة سنوية ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                semiannualPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(this.baseDate, (index + 1) * 6, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `دفعة نصف سنوية ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                // معالجة الدفعات الربع سنوية (المحددة)
                quarterlyPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(this.baseDate, (index + 1) * 3, installmentDay);
                    const amount = payment.amount;
                    
                    const pv = this.calculatePVWithDate(amount, paymentDate);
                    knownPV += pv;
                    
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `دفعة ربع سنوية ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                const remainingPV = this.cashValue - knownPV;
                // حساب الفترة الزمنية بين الأقساط بالشهور
                const monthsInterval = 12 / frequency; // ✅ التصحيح

                let startDate;
                if (quarterlyStartDate) {
                    const tempDate = new Date(quarterlyStartDate);
                    startDate = new Date(tempDate.getFullYear(), tempDate.getMonth(), installmentDay, 12, 0, 0);
                } else {
                    startDate = this.addMonthsWithDay(this.baseDate, monthsInterval, installmentDay); // ✅ استخدام المتغير
                }
                
                const numberOfQuarters = numberOfYears * frequency;
                const quarterlyDates = [];
                for (let i = 0; i < numberOfQuarters; i++) {
                    quarterlyDates.push(this.addMonthsWithDay(startDate, i * (12 / frequency), installmentDay));
                }

                const baseInstallment = this.findBaseInstallmentGraduated(remainingPV, quarterlyDates, growthRate / 100);

                // حماية: التحقق من أن القسط الأساسي موجب
                if (remainingPV <= 0 || baseInstallment <= 0) {
                    throw new Error(`⚠️ الدفعات المعروفة تتجاوز قيمة الكاش. يرجى تقليل المقدم أو الدفعات الإضافية.`);
                }

                quarterlyDates.forEach((date, index) => {
                    const amount = baseInstallment * Math.pow(1 + growthRate / 100, index);
                    const pv = this.calculatePVWithDate(amount, date);
                    schedule.push({
                        id: paymentId++,
                        type: `قسط متزايد ${index + 1}`,
                        date: this.formatDateLocal(date),
                        amount,
                        pv,
                        discount: amount - pv
                    });
                });

                const verification = this.verifyScheduleXNPV(schedule);

                return {
                    pattern: 'graduated',
                    patternName: 'نظام الأقساط المتزايدة',
                    downPayment,
                    baseInstallment,
                    growthRate,
                    numberOfInstallments: quarterlyDates.length,
                    annualPayments: annualPayments.length,
                    semiannualPayments: semiannualPayments.length,
                    quarterlyPayments: quarterlyPayments.length,
                    frequency,
                    schedule,
                    verification,
                    summary: this.calculateSummary(schedule)
                };
            }

            findBaseInstallmentGraduated(targetPV, dates, growthRate) {
                let low = 0, high = targetPV * 2, tolerance = 0.01;
                const maxIterations = 200;
                let iterations = 0;

                while (high - low > tolerance && iterations < maxIterations) {
                    const mid = (low + high) / 2;
                    
                    let calculatedPV = 0;
                    for (let i = 0; i < dates.length; i++) {
                        const amount = mid * Math.pow(1 + growthRate, i);
                        calculatedPV += this.calculatePVWithDate(amount, dates[i]);
                    }
                    
                    if (calculatedPV < targetPV) {
                        low = mid;
                    } else {
                        high = mid;
                    }
                    
                    iterations++;
                }
                
                return (low + high) / 2;
            }

            // ═══ CUSTOM DISTRIBUTION ═══
            calculateCustomDistribution(params) {
                const {
                    downPayment,
                    customPayments = [],
                    quarterlyYears = 0,
                    quarterlyStartDate = null,
                    installmentDay = 1,
                    remainingFrequency = 4 // 4=quarterly, 2=semiannual, 1=annual
                } = params;
                
                let knownPV = downPayment;
                const schedule = [{
                    id: 0,
                    type: 'مقدم',
                    date: this.formatDateLocal(this.baseDate),
                    amount: downPayment,
                    pv: downPayment,
                    discount: 0
                }];

                let paymentId = 1;

                customPayments.forEach((payment) => {
                    const baseAmount = payment.amount;

                    if (payment.frequency === 'once') {
                        const paymentDate = payment.startDate ? new Date(payment.startDate) : new Date();
                        const pv = this.calculatePVWithDate(baseAmount, paymentDate);
                        knownPV += pv;
                        
                        schedule.push({
                            id: paymentId++,
                            type: payment.type || 'دفعة',
                            date: this.formatDateLocal(paymentDate),
                            amount: baseAmount,
                            pv,
                            discount: baseAmount - pv
                        });
                    } else {
                        // تحديد الفترة بين الدفعات حسب النوع
                        let monthsInterval;
                        switch (payment.frequency) {
                            case 'annual':
                                monthsInterval = 12;
                                break;
                            case 'semiannual':
                                monthsInterval = 6;
                                break;
                            case 'quarterly':
                                monthsInterval = 3;
                                break;
                            default:
                                monthsInterval = 12;
                        }
                        
                        const numberOfPayments = payment.numberOfPayments || 1;
                        const startDate = payment.startDate ? new Date(payment.startDate) : new Date();
                        
                        for (let i = 0; i < numberOfPayments; i++) {
                            const paymentDate = this.addMonthsWithDay(startDate, i * monthsInterval, installmentDay);
                            const pv = this.calculatePVWithDate(baseAmount, paymentDate);
                            knownPV += pv;
                            
                            schedule.push({
                                id: paymentId++,
                                type: `${payment.type || 'دفعة'} ${i + 1}`,
                                date: this.formatDateLocal(paymentDate),
                                amount: baseAmount,
                                pv,
                                discount: baseAmount - pv
                            });
                        }
                    }
                });

                if (quarterlyYears > 0) {
                    const remainingPV = this.cashValue - knownPV;
                    
                    // حماية: إذا كانت القيمة المتبقية سالبة أو صفرية، لا يتم إنشاء أقساط
                    if (remainingPV <= 0) {
                        // تحذير: الدفعات المعروفة تغطي أو تتجاوز قيمة الكاش
                        console.warn('⚠️ القيمة المتبقية سالبة أو صفرية. الدفعات المعروفة تغطي كامل قيمة الكاش.');
                    } else {
                    const monthsInterval = 12 / remainingFrequency; // dynamic based on frequency
                    let startDate;
                    if (quarterlyStartDate) {
                        const tempDate = new Date(quarterlyStartDate);
                        startDate = new Date(tempDate.getFullYear(), tempDate.getMonth(), installmentDay, 12, 0, 0);
                    } else {
                        startDate = this.addMonthsWithDay(this.baseDate, monthsInterval, installmentDay); 
                    }
                    
                    const numberOfInstallments = quarterlyYears * remainingFrequency;
                    const installmentDates = [];
                    for (let i = 0; i < numberOfInstallments; i++) {
                        installmentDates.push(this.addMonthsWithDay(startDate, i * monthsInterval, installmentDay));
                    }

                    const installmentAmount = this.findEqualInstallmentXNPV(remainingPV, installmentDates, remainingFrequency);

                    // Determine installment type label based on frequency
                    let installmentTypeLabel;
                    switch (remainingFrequency) {
                        case 1: installmentTypeLabel = 'قسط سنوي'; break;
                        case 2: installmentTypeLabel = 'قسط نصف سنوي'; break;
                        case 4: installmentTypeLabel = 'قسط ربع سنوي'; break;
                        default: installmentTypeLabel = 'قسط'; break;
                    }

                    installmentDates.forEach((date, index) => {
                        const pv = this.calculatePVPeriodic(installmentAmount, index + 1, remainingFrequency);
                        schedule.push({
                            id: paymentId++,
                            type: `${installmentTypeLabel} ${index + 1}`,
                            date: this.formatDateLocal(date),
                            amount: installmentAmount,
                            pv,
                            discount: installmentAmount - pv
                        });
                    });
                    }
                }

                const verification = this.verifyScheduleXNPV(schedule, remainingFrequency);

                return {
                    pattern: 'custom',
                    patternName: 'نظام التوزيع المخصص',
                    downPayment,
                    customPayments,
                    schedule,
                    verification,
                    summary: this.calculateSummary(schedule)
                };
            }

            // ═══ BASE SYSTEM ═══
            calculateBaseSystem(baseSystemConfig, unitValue) {
                if (!baseSystemConfig) return null;

                const downPaymentDate = baseSystemConfig.downPaymentDate 
                    ? new Date(baseSystemConfig.downPaymentDate) 
                    : this.baseDate;
                const installmentDay = 1;

                const downPayment = baseSystemConfig.downPaymentIsPercentage 
                    ? unitValue * (baseSystemConfig.downPaymentValue / 100)
                    : baseSystemConfig.downPaymentValue;

                const annualPayments = (baseSystemConfig.annualPayments || []).map(p => ({
                    type: p.type,
                    amount: p.isPercentage ? unitValue * (p.value / 100) : p.value,
                    date: p.date ? new Date(p.date) : null
                }));

                const semiannualPayments = (baseSystemConfig.semiannualPayments || []).map(p => ({
                    type: p.type,
                    amount: p.isPercentage ? unitValue * (p.value / 100) : p.value,
                    date: p.date ? new Date(p.date) : null
                }));

                const quarterlyPayments = (baseSystemConfig.quarterlyPayments || []).map(p => ({
                    type: p.type,
                    amount: p.isPercentage ? unitValue * (p.value / 100) : p.value,
                    date: p.date ? new Date(p.date) : null
                }));

                // ═══ النظام الأساسي: توزيع سعر الوحدة (وليس Cash Value) ═══
                // الإجمالي المدفوع = سعر الوحدة بالضبط
                // المقدم والدفعات كنسب من سعر الوحدة، والباقي يوزع بالتساوي
                
                let knownAmount = downPayment; // المبالغ المعروفة من سعر الوحدة
                const schedule = [{
                    id: 0,
                    type: 'مقدم',
                    date: this.formatDateLocal(downPaymentDate),
                    amount: downPayment,
                    pv: downPayment,
                    discount: 0
                }];
                let paymentId = 1;

                annualPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(downPaymentDate, (index + 1) * 12, installmentDay);
                    const pv = this.calculatePVWithDate(payment.amount, paymentDate);
                    knownAmount += payment.amount;
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `دفعة سنوية ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount: payment.amount,
                        pv,
                        discount: payment.amount - pv
                    });
                });

                semiannualPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(downPaymentDate, (index + 1) * 6, installmentDay);
                    const pv = this.calculatePVWithDate(payment.amount, paymentDate);
                    knownAmount += payment.amount;
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `دفعة نصف سنوية ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount: payment.amount,
                        pv,
                        discount: payment.amount - pv
                    });
                });

                quarterlyPayments.forEach((payment, index) => {
                    const paymentDate = payment.date ? new Date(new Date(payment.date).setHours(12, 0, 0)) : this.addMonthsWithDay(downPaymentDate, (index + 1) * 3, installmentDay);
                    const pv = this.calculatePVWithDate(payment.amount, paymentDate);
                    knownAmount += payment.amount;
                    schedule.push({
                        id: paymentId++,
                        type: payment.type || `دفعة ربع سنوية ${index + 1}`,
                        date: this.formatDateLocal(paymentDate),
                        amount: payment.amount,
                        pv,
                        discount: payment.amount - pv
                    });
                });

                // الباقي من سعر الوحدة يوزع بالتساوي على الأقساط
                const remainingAmount = unitValue - knownAmount;
                const frequency = 4; // quarterly
                const monthsInterval = 12 / frequency;
                const startDate = this.addMonthsWithDay(downPaymentDate, monthsInterval, installmentDay);
                const numberOfQuarters = baseSystemConfig.quarterlyYears * frequency;
                const quarterlyDates = [];
                for (let i = 0; i < numberOfQuarters; i++) {
                    quarterlyDates.push(this.addMonthsWithDay(startDate, i * monthsInterval, installmentDay));
                }

                // القسط = المتبقي من سعر الوحدة ÷ عدد الأقساط
                const installmentAmount = remainingAmount / numberOfQuarters;

                quarterlyDates.forEach((date, index) => {
                    const pv = this.calculatePVPeriodic(installmentAmount, index + 1, frequency);
                    schedule.push({
                        id: paymentId++,
                        type: `قسط موحد ${index + 1}`,
                        date: this.formatDateLocal(date),
                        amount: installmentAmount,
                        pv,
                        discount: installmentAmount - pv
                    });
                });

                const verification = this.verifyScheduleXNPV(schedule, frequency);

                return {
                    pattern: 'equal',
                    patternName: 'النظام الأساسي',
                    downPayment,
                    installmentAmount,
                    numberOfInstallments: numberOfQuarters,
                    annualPayments: annualPayments.length,
                    semiannualPayments: semiannualPayments.length,
                    quarterlyPayments: quarterlyPayments.length,
                    frequency,
                    schedule,
                    verification,
                    summary: this.calculateSummary(schedule)
                };
            }

            // ═══ IMPLIED DISCOUNT RATE ═══
            calculateImpliedDiscountRate(baseSystem, unitValue) {
                const targetPV = this.cashValue;
                const payments = [];
                
                const downPaymentDate = baseSystem.downPaymentDate 
                    ? new Date(baseSystem.downPaymentDate) 
                    : this.baseDate;
                
                const downPayment = baseSystem.downPaymentIsPercentage 
                    ? unitValue * (baseSystem.downPaymentValue / 100)
                    : baseSystem.downPaymentValue;
                    
                payments.push({ amount: downPayment, date: downPaymentDate });
                
                // الدفعات السنوية
                if (baseSystem.annualPayments && baseSystem.annualPayments.length > 0) {
                    baseSystem.annualPayments.forEach((payment, index) => {
                        const date = payment.date 
                            ? new Date(payment.date) 
                            : this.addMonths(downPaymentDate, (index + 1) * 12);
                        const amount = payment.isPercentage 
                            ? unitValue * (payment.value / 100)
                            : payment.value;
                        payments.push({ amount, date });
                    });
                }

                // الدفعات نصف السنوية
                if (baseSystem.semiannualPayments && baseSystem.semiannualPayments.length > 0) {
                    baseSystem.semiannualPayments.forEach((payment, index) => {
                        const date = payment.date 
                            ? new Date(payment.date) 
                            : this.addMonths(downPaymentDate, (index + 1) * 6);
                        const amount = payment.isPercentage 
                            ? unitValue * (payment.value / 100)
                            : payment.value;
                        payments.push({ amount, date });
                    });
                }

                // الدفعات الربع سنوية المحددة
                if (baseSystem.quarterlyPayments && baseSystem.quarterlyPayments.length > 0) {
                    baseSystem.quarterlyPayments.forEach((payment, index) => {
                        const date = payment.date 
                            ? new Date(payment.date) 
                            : this.addMonths(downPaymentDate, (index + 1) * 3);
                        const amount = payment.isPercentage 
                            ? unitValue * (payment.value / 100)
                            : payment.value;
                        payments.push({ amount, date });
                    });
                }
                
                let knownAmount = payments.reduce((sum, p) => sum + p.amount, 0);
                let remainingAmount = unitValue - knownAmount;
                
                const numberOfQuarters = baseSystem.quarterlyYears * 4;
                const quarterlyAmount = remainingAmount / numberOfQuarters;
                
                for (let i = 0; i < numberOfQuarters; i++) {
                    const date = this.addMonths(downPaymentDate, (i + 1) * 3);
                    payments.push({ amount: quarterlyAmount, date });
                }
                
                return this.findDiscountRateXNPV(payments, targetPV);
            }

            findDiscountRateXNPV(payments, targetPV, tolerance = 0.00001) {
                let lowRate = 0.00;
                let highRate = 0.50;
                let iterations = 0;
                const maxIterations = 100;
                
                const cashFlows = payments.map(p => ({
                    date: p.date,
                    amount: p.amount
                }));

                while (highRate - lowRate > tolerance && iterations < maxIterations) {
                    const midRate = (lowRate + highRate) / 2;
                    
                    const calculatedPV = this.calculateXNPV(midRate, cashFlows);
                    
                    if (calculatedPV < targetPV) {
                        highRate = midRate;
                    } else {
                        lowRate = midRate;
                    }
                    
                    iterations++;
                }
                
                const finalRate = (lowRate + highRate) / 2;
                return finalRate * 100;
            }

            // ═══ VERIFICATION ═══
            verifyScheduleXNPV(schedule, frequency) {
                let totalPV;
                
                if (frequency && frequency > 0) {
                    // Periodic verification (for equal/custom installments using annuity formula)
                    const r_periodic = Math.pow(1 + this.discountRate, 1 / frequency) - 1;
                    totalPV = 0;
                    let periodCounter = 0;
                    schedule.forEach(p => {
                        if (p.type === 'مقدم' || p.type.includes('دفعة سنوية') || p.type.includes('دفعة نصف سنوية') || p.type.includes('دفعة ربع سنوية')) {
                            // Known payments: use date-based PV (as entered by user)
                            totalPV += p.pv;
                        } else {
                            // Regular installments: use periodic PV
                            periodCounter++;
                            totalPV += p.amount / Math.pow(1 + r_periodic, periodCounter);
                        }
                    });
                } else {
                    // XNPV verification (for decreasing/graduated)
                    const cashFlows = schedule.map(p => ({
                        date: new Date(p.date),
                        amount: p.amount
                    }));
                    totalPV = this.calculateXNPV(this.discountRate, cashFlows);
                }

                const totalPaid = schedule.reduce((sum, payment) => sum + payment.amount, 0);
                const difference = totalPV - this.cashValue;
                const percentDiff = (difference / this.cashValue) * 100;
                
                return {
                    totalPV,
                    totalPaid,
                    cashValue: this.cashValue,
                    difference,
                    percentDiff,
                    status: Math.abs(difference) < 1000 ? 'مطابق ✅' : 'غير مطابق ❌',
                    accuracy: Math.abs(percentDiff) < 0.1 ? 'دقة عالية' : 'يحتاج تعديل'
                };
            }

            calculateSummary(schedule) {
                const totalPaid = schedule.reduce((sum, p) => sum + p.amount, 0);
                const totalPV = schedule.reduce((sum, p) => sum + p.pv, 0);
                const totalDiscount = schedule.reduce((sum, p) => sum + p.discount, 0);
                
                return {
                    numberOfPayments: schedule.length,
                    totalPaid,
                    totalPV,
                    totalDiscount,
                    effectiveInterestRate: ((totalPaid - this.cashValue) / this.cashValue) * 100,
                    averagePayment: totalPaid / schedule.length
                };
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // BETA SMART FINANCE - نظام التقسيط المرن
        // ═══════════════════════════════════════════════════════════════

        function BetaSmartFinance() {
            const [isAdmin, setIsAdmin] = useState(false);
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [adminPassword, setAdminPassword] = useState('');
            const ADMIN_PASSWORD = 'beta2025';
            const [dbReady, setDbReady] = useState(false);
            const [dbStats, setDbStats] = useState({});
            const [showHistory, setShowHistory] = useState(false);
            const [calcHistory, setCalcHistory] = useState([]);

            const DEFAULT_PROJECTS = [
                   
                    { 
                        id: 1, 
                        name: 'بيتا ريزيدنس أكتوبر', 
                        cashDiscountRate: 30, 
                        discountRate: 14.00,
                        discountRateMode: 'manual',
                        minDownPaymentPercent: 5,
                        maxInstallmentYears: 8,
                        baseSystem: {
                            downPaymentValue: 15,
                            downPaymentIsPercentage: true,
                            downPaymentDate: null,
                            annualPayments: [{ value: 10, isPercentage: true, type: 'دفعة سنوية', date: null }],
                            semiannualPayments: [],
                            quarterlyPayments: [],
                            quarterlyYears: 8
                        },
                        description: 'مجمع سكني فاخر', 
                        color: 'purple' 
                    },
                    { 
                        id: 2, 
                        name: 'بيتا جرينز - مستقبل سيتى', 
                        cashDiscountRate: 28.24, 
                        discountRate: 23.996,
                        discountRateMode: 'manual',
                        minDownPaymentPercent: 30,
                        maxInstallmentYears: 5,
                        baseSystem: {
                            downPaymentValue: 30,
                            downPaymentIsPercentage: true,
                            downPaymentDate: null,
                            annualPayments: [],
                            semiannualPayments: [],
                            quarterlyPayments: [],
                            quarterlyYears: 5
                        },
                        description: '🎯 استلام فورى: 30% مقدم و70% على 5 سنوات | مشروع متميز في مستقبل سيتى', 
                        color: 'green' 
                    },
                    { 
                        id: 3, 
                        name: 'عرض بيتا جرينز - مستقبل سيتى', 
                        cashDiscountRate: 8.00, 
                        discountRate: 20.00,
                        discountRateMode: 'manual',
                        minDownPaymentPercent: 50,
                        maxInstallmentYears: 4,
                        baseSystem: {
                            downPaymentValue: 50,
                            downPaymentIsPercentage: true,
                            downPaymentDate: null,
                            annualPayments: [],
                            semiannualPayments: [],
                            quarterlyPayments: [],
                            quarterlyYears: 2
                        },
                        description: '🎯 عرض خاص: 50% مقدم والباقي على سنتين | مشروع متميز في مستقبل سيتى', 
                        color: 'blue' 
                    }
                ];

            const [projects, setProjects] = useState(DEFAULT_PROJECTS);
            
            // Initialize SQLite DB on mount
            useEffect(() => {
                betaDB.init().then(success => {
                    if (success) {
                        setDbReady(true);
                        const dbProjects = betaDB.getAllProjects();
                        if (dbProjects.length > 0) {
                            setProjects(dbProjects);
                        } else {
                            // Save defaults to DB
                            DEFAULT_PROJECTS.forEach(p => betaDB.saveProject(p));
                        }
                        setDbStats(betaDB.getStats());
                        console.log('✅ SQLite database ready');
                    } else {
                        console.warn('⚠️ SQLite failed, using localStorage fallback');
                        const saved = localStorage.getItem('betaProjects_v2_9');
                        if (saved) setProjects(JSON.parse(saved));
                    }
                });
            }, []);

            // Sync projects to SQLite (and localStorage as fallback)
            useEffect(() => {
                if (dbReady) {
                    projects.forEach(p => betaDB.saveProject(p));
                    // Clean deleted projects from DB
                    const dbProjects = betaDB.getAllProjects();
                    const currentIds = projects.map(p => p.id);
                    dbProjects.forEach(dp => {
                        if (!currentIds.includes(dp.id)) {
                            betaDB.deleteProject(dp.id);
                        }
                    });
                    setDbStats(betaDB.getStats());
                }
                // localStorage fallback
                localStorage.setItem('betaProjects_v2_9', JSON.stringify(projects));
            }, [projects, dbReady]);

            // ═══ DB Helper Functions ═══
            const saveCalculationToDB = (result, projectId) => {
                if (!dbReady) return;
                betaDB.saveCalculation({
                    projectId,
                    unitValue,
                    unitNumber,
                    pattern: result.pattern || selectedPattern,
                    frequency: result.frequency || frequency,
                    downPayment: result.downPayment,
                    numberOfYears: numberOfYears,
                    totalPaid: result.summary?.totalPaid || 0,
                    totalPV: result.summary?.totalPV || 0,
                    schedule: result.schedule,
                    verification: result.verification
                });
                setDbStats(betaDB.getStats());
            };

            const loadHistory = () => {
                if (!dbReady) return;
                setCalcHistory(betaDB.getCalculationHistory(null, 50));
                setShowHistory(true);
            };

            const exportDB = () => {
                if (!dbReady) { alert('⚠️ قاعدة البيانات غير جاهزة'); return; }
                betaDB.exportDatabase();
            };

            const importDB = () => {
                if (!dbReady) { alert('⚠️ قاعدة البيانات غير جاهزة'); return; }
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.sqlite,.db';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try {
                        await betaDB.importDatabase(file);
                        const dbProjects = betaDB.getAllProjects();
                        if (dbProjects.length > 0) setProjects(dbProjects);
                        setDbStats(betaDB.getStats());
                        alert('✅ تم استيراد قاعدة البيانات بنجاح');
                    } catch (err) {
                        alert('❌ خطأ في استيراد قاعدة البيانات: ' + err.message);
                    }
                };
                input.click();
            };

            const [showProjectsManager, setShowProjectsManager] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            const [selectedProjectId, setSelectedProjectId] = useState(1);
            const [showBaseSystemModal, setShowBaseSystemModal] = useState(false);
            const [currentProjectForBaseSystem, setCurrentProjectForBaseSystem] = useState(null);
            const [tempBaseSystem, setTempBaseSystem] = useState({
                downPaymentValue: 10,
                downPaymentIsPercentage: true,
                annualPayments: [],
                semiannualPayments: [],
                quarterlyPayments: [],
                quarterlyYears: 8,
                startDate: ''
            });

            const [unitValue, setUnitValue] = useState(1000000);
            const [unitNumber, setUnitNumber] = useState('');
            const [selectedPattern, setSelectedPattern] = useState('equal');
            const [results, setResults] = useState(null);
            const [baseSystemResults, setBaseSystemResults] = useState(null);
            const [showComparison, setShowComparison] = useState(false);

            // Installment Details
            const [downPaymentValue, setDownPaymentValue] = useState(20);
            const [downPaymentIsPercentage, setDownPaymentIsPercentage] = useState(true);
            const [numberOfYears, setNumberOfYears] = useState(8);
            const [frequency, setFrequency] = useState(4); // 4 = quarterly, 2 = semiannual, 1 = annual, 12 = monthly
            const [decreaseRate, setDecreaseRate] = useState(2);
            const [growthRate, setGrowthRate] = useState(3);
            const [quarterlyStartDate, setQuarterlyStartDate] = useState('');
            const [installmentDay, setInstallmentDay] = useState(1); // 1 or 15
            const [roundingOption, setRoundingOption] = useState('100'); // 'none', '100', '500', '1000'

            // Additional Payments
            const [annualPayments, setAnnualPayments] = useState([]);
            const [semiannualPayments, setSemiannualPayments] = useState([]);
            const [quarterlyPayments, setQuarterlyPayments] = useState([]);
            
            // Custom Distribution
            const [customPayments, setCustomPayments] = useState([]);
            const [customQuarterlyYears, setCustomQuarterlyYears] = useState(0);
            const [customQuarterlyStartDate, setCustomQuarterlyStartDate] = useState('');
            const [customRemainingFrequency, setCustomRemainingFrequency] = useState(4); // 4=quarterly, 2=semiannual, 1=annual

            const getSelectedProject = () => projects.find(p => p.id === selectedProjectId);

            const patterns = [
                { id: 'equal', name: 'قسط موحد', description: 'قسط ثابت طوال المدة', color: 'blue', icon: '💰' },
                { id: 'decreasing', name: 'قسط متناقص', description: 'قسط يتناقص مع الوقت', color: 'red', icon: '📉' },
                { id: 'graduated', name: 'قسط متزايد', description: 'قسط يتزايد مع الوقت', color: 'purple', icon: '📈' },
                { id: 'custom', name: 'توزيع مخصص', description: 'أنت تحدد الدفعات', color: 'amber', icon: '⚡' },
            ];

            const formatCurrency = (value) => {
                return new Intl.NumberFormat('ar-EG', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value) + ' ج';
            };

            const formatDate = (dateString) => {
                return new Date(dateString).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
            };

            // دالة تقريب القسط للأعلى (لأقرب صفرين = 100)
            const roundInstallmentUp = (amount, roundTo = 100) => {
                return Math.ceil(amount / roundTo) * roundTo;
            };
            
            // دالة تطبيق التقريب التلقائي على جدول الدفعات (للأعلى لأقرب 100)
            const applyAutoRoundingToSchedule = (schedule) => {
                return schedule.map(payment => {
                    // لا نقرب المقدم أو الدفعات المحددة (السنوية/نصف سنوية/ربع سنوية المحددة)
                    if (payment.type === 'مقدم' || payment.type.includes('دفعة سنوية') || payment.type.includes('دفعة نصف سنوية') || payment.type.includes('دفعة ربع سنوية') || payment.type.includes('دفعة مخصصة')) {
                        return payment;
                    }
                    // تقريب الأقساط للأعلى لأقرب 100
                    const roundedAmount = roundInstallmentUp(payment.amount, 100);
                    return { ...payment, amount: roundedAmount, discount: roundedAmount - payment.pv };
                });
            };

            // دالة تقريب القسط (للخيارات الإضافية)
            const roundInstallment = (amount, option) => {
                if (option === 'none' || !option) return amount;
                const roundTo = parseInt(option);
                // التقريب للأعلى دائماً
                return Math.ceil(amount / roundTo) * roundTo;
            };

            // دالة تطبيق التقريب على جدول الدفعات (للخيارات الإضافية)
            const applyRoundingToSchedule = (schedule, roundingOpt) => {
                if (roundingOpt === 'none' || !roundingOpt) return schedule;

                return schedule.map(payment => {
                    // لا نقرب المقدم أو الدفعات المحددة
                    if (payment.type === 'مقدم' || payment.type.includes('دفعة سنوية') || payment.type.includes('دفعة نصف سنوية') || payment.type.includes('دفعة ربع سنوية') || payment.type.includes('دفعة مخصصة')) {
                        return payment;
                    }

                    const roundedAmount = roundInstallment(payment.amount, roundingOpt);
                    return { ...payment, amount: roundedAmount, discount: roundedAmount - payment.pv };
                });
            };

            const handlePrint = () => {
                if (!results) return;

                const project = getSelectedProject();
                const today = new Date().toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
                const cashValue = project?.cashDiscountRate ? unitValue * (1 - project.cashDiscountRate / 100) : unitValue;
                const installments = results.schedule.filter(p => p.type.includes('قسط'));
                const firstInstallment = installments[0];
                const lastInstallment = installments[installments.length - 1];

                // بناء صفوف الجدول
                let tableRows = '';
                results.schedule.forEach((p, index) => {
                    const isDown = p.type === 'مقدم';
                    const bgColor = isDown ? '#EFF6FF' : (index % 2 === 0 ? '#FFFFFF' : '#F9FAFB');
                    const fw = isDown ? 'bold' : 'normal';
                    tableRows += '<tr style="background:' + bgColor + '; font-weight:' + fw + '">' +
                        '<td style="padding:7px 10px; border:1px solid #D1D5DB; text-align:center; width:8%">' + p.id + '</td>' +
                        '<td style="padding:7px 10px; border:1px solid #D1D5DB; text-align:center; width:28%">' + new Date(p.date).toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' }) + '</td>' +
                        '<td style="padding:7px 10px; border:1px solid #D1D5DB; text-align:center; width:30%">' + p.type + '</td>' +
                        '<td style="padding:7px 10px; border:1px solid #D1D5DB; text-align:center; font-weight:bold; width:34%">' + formatCurrency(p.amount) + '</td>' +
                        '</tr>';
                });
                // صف الإجمالي
                tableRows += '<tr style="background:#1F2937; color:white; font-weight:bold">' +
                    '<td style="padding:10px; border:1px solid #374151; text-align:center" colspan="3">الإجمالي المدفوع</td>' +
                    '<td style="padding:10px; border:1px solid #374151; text-align:center; font-size:14px">' + formatCurrency(results.summary.totalPaid) + '</td>' +
                    '</tr>';

                const pdfHTML = `
<div id="pdf-render-area" style="font-family: Tahoma, Arial, sans-serif; direction:rtl; color:#1F2937; width:700px; margin:0 auto; padding:0 10px;">

    <!-- HEADER -->
    <table style="width:100%; border-collapse:collapse; margin-bottom:14px">
        <tr>
            <td style="background:#1a1a1a; color:white; padding:18px 20px; border-top:5px solid #DC143C; border-radius:0">
                <table style="width:100%; border-collapse:collapse">
                    <tr>
                        <td style="text-align:right; vertical-align:middle">
                            <div style="font-size:20px; font-weight:bold; margin:0">شركة بيتا للتطوير العقاري</div>
                            <div style="font-size:11px; color:#9CA3AF; margin-top:3px">BETA Real Estate Development | SINCE 1993</div>
                        </td>
                        <td style="text-align:left; vertical-align:middle; font-size:10px; color:#9CA3AF">
                            <div>هاتف: 19231</div>
                            <div style="margin-top:2px">info@betadevelopments.com</div>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

    <!-- TITLE -->
    <table style="width:100%; border-collapse:collapse; margin-bottom:14px">
        <tr>
            <td style="text-align:center; padding:12px; background:#FEF2F2; border:2px solid #DC143C">
                <div style="font-size:18px; color:#DC143C; font-weight:bold">خطة سداد الوحدة</div>
                <div style="font-size:12px; color:#6B7280; margin-top:4px">تاريخ الإصدار: ${today}</div>
            </td>
        </tr>
    </table>

    <!-- UNIT INFO -->
    <table style="width:100%; border-collapse:collapse; margin-bottom:12px; font-size:12px">
        <tr>
            <td style="padding:8px 12px; background:#F3F4F6; border:1px solid #D1D5DB; font-weight:bold; width:20%; text-align:right">المشروع</td>
            <td style="padding:8px 12px; border:1px solid #D1D5DB; width:30%; text-align:right">${project?.name || '-'}</td>
            <td style="padding:8px 12px; background:#F3F4F6; border:1px solid #D1D5DB; font-weight:bold; width:20%; text-align:right">رقم الوحدة / العميل</td>
            <td style="padding:8px 12px; border:1px solid #D1D5DB; width:30%; text-align:right">${unitNumber || 'غير محدد'}</td>
        </tr>
        <tr>
            <td style="padding:8px 12px; background:#F3F4F6; border:1px solid #D1D5DB; font-weight:bold; text-align:right">قيمة الوحدة</td>
            <td style="padding:8px 12px; border:1px solid #D1D5DB; font-weight:bold; color:#DC143C; text-align:right">${formatCurrency(unitValue)}</td>
            <td style="padding:8px 12px; background:#F3F4F6; border:1px solid #D1D5DB; font-weight:bold; text-align:right">نظام السداد</td>
            <td style="padding:8px 12px; border:1px solid #D1D5DB; text-align:right">${results.patternName}</td>
        </tr>
        <tr>
            <td style="padding:8px 12px; background:#F3F4F6; border:1px solid #D1D5DB; font-weight:bold; text-align:right">خصم الكاش</td>
            <td style="padding:8px 12px; border:1px solid #D1D5DB; text-align:right">${project?.cashDiscountRate || 0}%</td>
            <td style="padding:8px 12px; background:#F3F4F6; border:1px solid #D1D5DB; font-weight:bold; text-align:right">قيمة الكاش (PV)</td>
            <td style="padding:8px 12px; border:1px solid #D1D5DB; font-weight:bold; color:#1D4ED8; text-align:right">${formatCurrency(cashValue)}</td>
        </tr>
    </table>

    <!-- SUMMARY BOXES -->
    <table style="width:100%; border-collapse:collapse; margin-bottom:14px">
        <tr>
            <td style="width:25%; padding:4px">
                <table style="width:100%; border-collapse:collapse">
                    <tr><td style="background:#F3F4F6; padding:10px 8px; text-align:center; border:1px solid #E5E7EB">
                        <div style="font-size:10px; color:#6B7280">المقدم</div>
                        <div style="font-size:15px; font-weight:bold; margin-top:4px">${formatCurrency(results.downPayment)}</div>
                    </td></tr>
                </table>
            </td>
            <td style="width:25%; padding:4px">
                <table style="width:100%; border-collapse:collapse">
                    <tr><td style="background:#FEF2F2; padding:10px 8px; text-align:center; border:1px solid #FECACA">
                        <div style="font-size:10px; color:#6B7280">القسط ${installments.length > 0 && firstInstallment?.amount !== lastInstallment?.amount ? 'الأول' : ''}</div>
                        <div style="font-size:15px; font-weight:bold; color:#DC143C; margin-top:4px">${formatCurrency(firstInstallment?.amount || 0)}</div>
                    </td></tr>
                </table>
            </td>
            <td style="width:25%; padding:4px">
                <table style="width:100%; border-collapse:collapse">
                    <tr><td style="background:#F3F4F6; padding:10px 8px; text-align:center; border:1px solid #E5E7EB">
                        <div style="font-size:10px; color:#6B7280">عدد الدفعات</div>
                        <div style="font-size:15px; font-weight:bold; margin-top:4px">${results.schedule.length - 1}</div>
                    </td></tr>
                </table>
            </td>
            <td style="width:25%; padding:4px">
                <table style="width:100%; border-collapse:collapse">
                    <tr><td style="background:#ECFDF5; padding:10px 8px; text-align:center; border:1px solid #A7F3D0">
                        <div style="font-size:10px; color:#6B7280">الإجمالي</div>
                        <div style="font-size:15px; font-weight:bold; color:#059669; margin-top:4px">${formatCurrency(results.summary.totalPaid)}</div>
                    </td></tr>
                </table>
            </td>
        </tr>
    </table>

    <!-- SCHEDULE TABLE TITLE -->
    <div style="font-size:14px; font-weight:bold; margin-bottom:6px; padding-bottom:5px; border-bottom:2px solid #DC143C">جدول الدفعات المفصل</div>
    
    <table style="width:100%; border-collapse:collapse; font-size:11px">
        <thead>
            <tr style="background:#DC143C; color:white">
                <th style="padding:8px 10px; border:1px solid #B91C1C; text-align:center; width:8%">#</th>
                <th style="padding:8px 10px; border:1px solid #B91C1C; text-align:center; width:28%">تاريخ الدفعة</th>
                <th style="padding:8px 10px; border:1px solid #B91C1C; text-align:center; width:30%">نوع الدفعة</th>
                <th style="padding:8px 10px; border:1px solid #B91C1C; text-align:center; width:34%">المبلغ (ج.م)</th>
            </tr>
        </thead>
        <tbody>
            ${tableRows}
        </tbody>
    </table>

    ${isAdmin ? `
    <!-- ADMIN DETAILS -->
    <table style="width:100%; border-collapse:collapse; margin-top:14px; font-size:11px; border:1px solid #BFDBFE">
        <tr>
            <td colspan="4" style="background:#1E40AF; color:white; padding:8px 12px; font-weight:bold; font-size:12px; text-align:right">تفاصيل مالية (نسخة المدير)</td>
        </tr>
        <tr>
            <td style="padding:7px 10px; border:1px solid #DBEAFE; background:#F0F9FF; font-weight:bold; width:25%; text-align:right">القيمة الحالية (PV)</td>
            <td style="padding:7px 10px; border:1px solid #DBEAFE; width:25%; color:#1D4ED8; font-weight:bold; text-align:right">${formatCurrency(results.verification.totalPV)}</td>
            <td style="padding:7px 10px; border:1px solid #DBEAFE; background:#F0F9FF; font-weight:bold; width:25%; text-align:right">إجمالي الخصم</td>
            <td style="padding:7px 10px; border:1px solid #DBEAFE; width:25%; color:#DC2626; font-weight:bold; text-align:right">${formatCurrency(results.summary.totalDiscount)}</td>
        </tr>
        <tr>
            <td style="padding:7px 10px; border:1px solid #DBEAFE; background:#F0F9FF; font-weight:bold; text-align:right">نسبة الزيادة الكلية</td>
            <td style="padding:7px 10px; border:1px solid #DBEAFE; color:#EA580C; font-weight:bold; text-align:right">${((results.summary.totalPaid / cashValue - 1) * 100).toFixed(2)}%</td>
            <td style="padding:7px 10px; border:1px solid #DBEAFE; background:#F0F9FF; font-weight:bold; text-align:right">حالة المطابقة</td>
            <td style="padding:7px 10px; border:1px solid #DBEAFE; font-weight:bold; text-align:right; color:${results.verification.status.includes('مطابق') ? '#059669' : '#DC2626'}">${results.verification.status}</td>
        </tr>
    </table>
    ` : ''}

    <!-- SIGNATURES -->
    <table style="width:100%; border-collapse:collapse; margin-top:30px">
        <tr>
            <td style="width:50%; padding:0 20px; text-align:center; vertical-align:bottom">
                <div style="border-bottom:2px dashed #9CA3AF; height:50px; margin-bottom:8px"></div>
                <div style="font-weight:bold; font-size:12px">توقيع العميل</div>
            </td>
            <td style="width:50%; padding:0 20px; text-align:center; vertical-align:bottom">
                <div style="border-bottom:2px dashed #9CA3AF; height:50px; margin-bottom:8px"></div>
                <div style="font-weight:bold; font-size:12px">توقيع الشركة</div>
            </td>
        </tr>
    </table>

    <!-- FOOTER -->
    <table style="width:100%; border-collapse:collapse; margin-top:20px; border-top:2px solid #E5E7EB">
        <tr>
            <td style="text-align:center; padding:10px; font-size:10px; color:#9CA3AF">
                <div>شركة بيتا للتطوير العقاري - BETA Real Estate Development</div>
                <div style="margin-top:3px">هاتف: 19231 | info@betadevelopments.com | جميع الحقوق محفوظة &copy; ${new Date().getFullYear()}</div>
            </td>
        </tr>
    </table>

</div>`;

                // ═══ إنشاء عنصر مؤقت ═══
                const container = document.createElement('div');
                container.style.cssText = 'position:fixed; left:-9999px; top:0; width:740px; background:white; z-index:-1;';
                container.innerHTML = pdfHTML;
                document.body.appendChild(container);
                const renderEl = container.querySelector('#pdf-render-area');

                // رسالة انتظار
                const loadingMsg = document.createElement('div');
                loadingMsg.innerHTML = '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999"><div style="background:white;padding:30px 50px;border-radius:12px;text-align:center"><p style="font-size:18px;margin:0;font-weight:bold">جاري إنشاء ملف PDF...</p><p style="font-size:14px;color:#666;margin-top:8px">يرجى الانتظار</p></div></div>';
                document.body.appendChild(loadingMsg);

                const opt = {
                    margin: [6, 4, 8, 4],
                    filename: `${project?.name || 'خطة_سداد'}_${unitNumber || 'وحدة'}_${results?.patternName || ''}_${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        letterRendering: true,
                        scrollY: 0,
                        width: 740
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['css', 'legacy'], avoid: ['tr'] }
                };

                html2pdf().set(opt).from(renderEl).save().then(() => {
                    document.body.removeChild(container);
                    document.body.removeChild(loadingMsg);
                }).catch((err) => {
                    document.body.removeChild(container);
                    document.body.removeChild(loadingMsg);
                    console.error('PDF Error:', err);
                    alert('حدث خطأ أثناء إنشاء الـ PDF');
                });
            };

            const calculateDownPayment = () => {
                return downPaymentIsPercentage ? unitValue * (downPaymentValue / 100) : downPaymentValue;
            };

            useEffect(() => {
                const project = getSelectedProject();
                if (project && project.baseSystem && unitValue > 0) {
                    if (selectedPattern === 'equal' || selectedPattern === 'decreasing' || selectedPattern === 'graduated') {
                        setDownPaymentValue(project.baseSystem.downPaymentValue);
                        setDownPaymentIsPercentage(project.baseSystem.downPaymentIsPercentage);
                        setNumberOfYears(project.baseSystem.quarterlyYears);
                        setFrequency(4); // الافتراضي هو ربع سنوي للنظام الأساسي

                        // جلب الدفعات الإضافية من النظام الأساسي
                        setAnnualPayments((project.baseSystem.annualPayments || []).map((p, index) => ({
                            id: index + 1,
                            type: p.type,
                            value: p.value,
                            isPercentage: p.isPercentage,
                            date: p.date ? new Date(p.date).toISOString().split('T')[0] : ''
                        })));
                        setSemiannualPayments((project.baseSystem.semiannualPayments || []).map((p, index) => ({
                            id: index + 1,
                            type: p.type,
                            value: p.value,
                            isPercentage: p.isPercentage,
                            date: p.date ? new Date(p.date).toISOString().split('T')[0] : ''
                        })));
                        setQuarterlyPayments((project.baseSystem.quarterlyPayments || []).map((p, index) => ({
                            id: index + 1,
                            type: p.type,
                            value: p.value,
                            isPercentage: p.isPercentage,
                            date: p.date ? new Date(p.date).toISOString().split('T')[0] : ''
                        })));
                        
                    } else if (selectedPattern === 'custom') {
                        // تصفير الخيارات عند التحول للتوزيع المخصص
                        setDownPaymentValue(20);
                        setDownPaymentIsPercentage(true);
                        setCustomPayments([]);
                        setCustomQuarterlyYears(0);
                        setCustomQuarterlyStartDate('');
                        setCustomRemainingFrequency(4);
                        setAnnualPayments([]);
                        setSemiannualPayments([]);
                        setQuarterlyPayments([]);
                    }
                }
                setResults(null);
                setBaseSystemResults(null);
                setShowComparison(false);
            }, [selectedProjectId, unitValue, selectedPattern]);

            const handleAdminLogin = () => {
                if (adminPassword === ADMIN_PASSWORD) {
                    setIsAdmin(true);
                    setShowAdminPanel(false);
                    alert('✅ تم تسجيل الدخول كمدير');
                } else {
                    alert('❌ كلمة المرور غير صحيحة');
                }
            };

            const calculateBaseSystemImpliedRate = () => {
                const project = getSelectedProject();
                if (!project || !unitValue || unitValue <= 0) {
                    alert('⚠️ يرجى إدخال قيمة الوحدة واختيار المشروع أولاً.');
                    return;
                }
                if (!tempBaseSystem.downPaymentValue) {
                    alert('⚠️ يرجى إدخال قيمة المقدم في النظام الأساسي.');
                    return;
                }
                if (!tempBaseSystem.quarterlyYears) {
                    alert('⚠️ يرجى إدخال عدد سنوات التقسيط في النظام الأساسي.');
                    return;
                }

                const engine = new SmartPaymentEngine(
                    unitValue, 
                    project.cashDiscountRate, 
                    0.0, // معدل خصم مؤقت لحساب الـ XNPV
                    new Date() 
                );

                const impliedRate = engine.calculateImpliedDiscountRate(tempBaseSystem, unitValue);

                const updatedProjects = projects.map(p => {
                    if (p.id === currentProjectForBaseSystem.id) {
                        return { ...p, 
                            discountRate: impliedRate, 
                            discountRateMode: 'auto', 
                            baseSystem: tempBaseSystem 
                        };
                    }
                    return p;
                });
                setProjects(updatedProjects);
                setShowBaseSystemModal(false);
                alert(`✅ تم حساب معدل الخصم للمشروع "${currentProjectForBaseSystem.name}"!\n\nمعدل الخصم المحسوب: ${impliedRate.toFixed(3)}%\n\nتم حفظ النظام الأساسي مع المشروع.`);
            };

            const addProject = () => {
                const newProject = {
                    id: Date.now(),
                    name: 'مشروع جديد',
                    cashDiscountRate: 30,
                    discountRate: 14.643,
                    discountRateMode: 'manual',
                    minDownPaymentPercent: 5,
                    maxInstallmentYears: 8, // ← إضافة الحد الأقصى الافتراضي
                    baseSystem: {
                        downPaymentValue: 15,
                        downPaymentIsPercentage: true,
                        annualPayments: [],
                        semiannualPayments: [],
                        quarterlyPayments: [],
                        quarterlyYears: 8,
                        downPaymentDate: null
                    },
                    description: 'وصف المشروع',
                    color: 'indigo'
                };
                setProjects([...projects, newProject]);
                setEditingProject(newProject.id);
            };

            const deleteProject = (projectId) => {
                if (projects.length === 1) {
                    alert('لا يمكن حذف آخر مشروع!');
                    return;
                }
                if (confirm('هل أنت متأكد من حذف هذا المشروع؟')) {
                    setProjects(projects.filter(p => p.id !== projectId));
                    if (selectedProjectId === projectId) {
                        setSelectedProjectId(projects.find(p => p.id !== projectId).id);
                    }
                }
            };

            const updateProject = (projectId, field, value) => {
                setProjects(projects.map(p => p.id === projectId ? { ...p, [field]: value } : p ));
            };

            const addAnnualPayment = () => {
                const today = new Date();
                const defaultDate = new Date(today);
                defaultDate.setFullYear(today.getFullYear() + annualPayments.length + 1);
                setAnnualPayments([...annualPayments, { id: Date.now(), type: `دفعة سنوية ${annualPayments.length + 1}`, value: 100000, isPercentage: false, date: defaultDate.toISOString().split('T')[0] }]);
            };
            const updateAnnualPayment = (id, field, value) => {
                setAnnualPayments(annualPayments.map(p => p.id === id ? { ...p, [field]: value } : p ));
            };
            const deleteAnnualPayment = (id) => {
                setAnnualPayments(annualPayments.filter(p => p.id !== id));
            };

            const addSemiannualPayment = () => {
                const today = new Date();
                const defaultDate = new Date(today);
                defaultDate.setMonth(today.getMonth() + (semiannualPayments.length + 1) * 6);
                setSemiannualPayments([...semiannualPayments, { id: Date.now(), type: `دفعة نصف سنوية ${semiannualPayments.length + 1}`, value: 50000, isPercentage: false, date: defaultDate.toISOString().split('T')[0] }]);
            };
            const updateSemiannualPayment = (id, field, value) => {
                setSemiannualPayments(semiannualPayments.map(p => p.id === id ? { ...p, [field]: value } : p ));
            };
            const deleteSemiannualPayment = (id) => {
                setSemiannualPayments(semiannualPayments.filter(p => p.id !== id));
            };

            const addQuarterlyPayment = () => {
                const today = new Date();
                const defaultDate = new Date(today);
                defaultDate.setMonth(today.getMonth() + (quarterlyPayments.length + 1) * 3);
                setQuarterlyPayments([...quarterlyPayments, { id: Date.now(), type: `دفعة ربع سنوية ${quarterlyPayments.length + 1}`, value: 25000, isPercentage: false, date: defaultDate.toISOString().split('T')[0] }]);
            };
            const updateQuarterlyPayment = (id, field, value) => {
                setQuarterlyPayments(quarterlyPayments.map(p => p.id === id ? { ...p, [field]: value } : p ));
            };
            const deleteQuarterlyPayment = (id) => {
                setQuarterlyPayments(quarterlyPayments.filter(p => p.id !== id));
            };

            const addCustomPayment = () => {
                const today = new Date();
                const defaultDate = new Date(today);
                defaultDate.setFullYear(today.getFullYear() + 1);
                setCustomPayments([...customPayments, { id: Date.now(), type: 'دفعة مخصصة', value: 100000, isPercentage: false, frequency: 'once', numberOfPayments: 1, startDate: defaultDate.toISOString().split('T')[0] }]);
            };
            const updateCustomPayment = (id, field, value) => {
                setCustomPayments(customPayments.map(p => p.id === id ? { ...p, [field]: value } : p ));
            };
            const deleteCustomPayment = (id) => {
                setCustomPayments(customPayments.filter(p => p.id !== id));
            };

            const calculateResults = () => {
                const project = getSelectedProject();
                if (!project) {
                    alert('⚠️ يرجى اختيار مشروع');
                    return;
                }
                if (!unitValue || unitValue <= 0) {
                    alert('⚠️ يرجى إدخال قيمة الوحدة');
                    return;
                }
                if (numberOfYears <= 0 && selectedPattern !== 'custom') {
                    alert('⚠️ يرجى إدخال عدد السنوات');
                    return;
                }
                
                // ✅ التحقق من الحد الأقصى لسنوات التقسيط
                const maxYears = project.maxInstallmentYears || 10;
                if (numberOfYears > maxYears && selectedPattern !== 'custom') {
                    alert(`⚠️ تنبيه للبائع:\n\nعدد سنوات التقسيط لا يمكن أن يتجاوز ${maxYears} سنوات لمشروع "${project.name}".\n\nعدد السنوات المدخل: ${numberOfYears} سنوات\nالحد الأقصى المسموح: ${maxYears} سنوات\n\nيرجى تقليل مدة التقسيط.`);
                    return;
                }

                const engine = new SmartPaymentEngine(
                    unitValue, 
                    project.cashDiscountRate, 
                    project.discountRate, 
                    new Date()
                );

                let result = null;
                const downPayment = calculateDownPayment();

                // التحقق من أن المقدم لا يقل عن الحد الأدنى المحدد للمشروع
                const minDownPaymentValue = unitValue * (project.minDownPaymentPercent / 100);
                if (downPayment < minDownPaymentValue) {
                    alert(`⚠️ تنبيه للبائع:\n\nالمقدم المدخل (${formatCurrency(downPayment)}) أقل من الحد الأدنى المسموح به للمشروع (${formatCurrency(minDownPaymentValue)}). يرجى زيادة المقدم.`);
                    return;
                }

                const annualPaymentsProcessed = annualPayments.map(p => ({
                    type: p.type,
                    amount: p.isPercentage ? unitValue * (p.value / 100) : p.value,
                    date: p.date
                }));
                const semiannualPaymentsProcessed = semiannualPayments.map(p => ({
                    type: p.type,
                    amount: p.isPercentage ? unitValue * (p.value / 100) : p.value,
                    date: p.date
                }));
                const quarterlyPaymentsProcessed = quarterlyPayments.map(p => ({
                    type: p.type,
                    amount: p.isPercentage ? unitValue * (p.value / 100) : p.value,
                    date: p.date
                }));

                const commonParams = {
                    downPayment,
                    numberOfYears,
                    frequency,
                    annualPayments: annualPaymentsProcessed,
                    semiannualPayments: semiannualPaymentsProcessed,
                    quarterlyPayments: quarterlyPaymentsProcessed,
                    quarterlyStartDate: quarterlyStartDate || null,
                    installmentDay: installmentDay // يوم استحقاق القسط
                };

                try {
                    switch (selectedPattern) {
                        case 'equal':
                            // التحقق: هل المدخلات تطابق النظام الأساسي؟
                            // لو نعم → الإجمالي = سعر الوحدة | لو لا → حساب PV-based
                            let isBaseSystemMatch = false;
                            if (project.baseSystem) {
                                const bs = project.baseSystem;
                                const baseFrequency = bs.frequency || 4; // التردد الأساسي (default: ربع سنوي)
                                const bsDP = bs.downPaymentIsPercentage ? unitValue * (bs.downPaymentValue / 100) : bs.downPaymentValue;
                                const bsAnnuals = (bs.annualPayments || []).map(p => p.isPercentage ? unitValue * (p.value / 100) : p.value);
                                const bsSemiannuals = (bs.semiannualPayments || []).map(p => p.isPercentage ? unitValue * (p.value / 100) : p.value);
                                const bsQuarterlies = (bs.quarterlyPayments || []).map(p => p.isPercentage ? unitValue * (p.value / 100) : p.value);
                                
                                const currentAnnualAmounts = annualPaymentsProcessed.map(p => p.amount);
                                const currentSemiannualAmounts = semiannualPaymentsProcessed.map(p => p.amount);
                                const currentQuarterlyAmounts = quarterlyPaymentsProcessed.map(p => p.amount);
                                
                                const dpMatch = Math.abs(downPayment - bsDP) < 1;
                                const yearsMatch = numberOfYears === bs.quarterlyYears;
                                const freqMatch = frequency === baseFrequency;
                                const annualMatch = bsAnnuals.length === currentAnnualAmounts.length && 
                                    bsAnnuals.every((v, i) => Math.abs(v - currentAnnualAmounts[i]) < 1);
                                const semiMatch = bsSemiannuals.length === currentSemiannualAmounts.length &&
                                    bsSemiannuals.every((v, i) => Math.abs(v - currentSemiannualAmounts[i]) < 1);
                                const qMatch = bsQuarterlies.length === currentQuarterlyAmounts.length &&
                                    bsQuarterlies.every((v, i) => Math.abs(v - currentQuarterlyAmounts[i]) < 1);
                                
                                isBaseSystemMatch = dpMatch && yearsMatch && freqMatch && annualMatch && semiMatch && qMatch;
                            }
                            
                            result = engine.calculateEqualInstallments({ ...commonParams, distributeUnitValue: isBaseSystemMatch });
                            break;
                        case 'decreasing':
                            result = engine.calculateDecreasingPayments({ ...commonParams, decreaseRate });
                            break;
                        case 'graduated':
                            result = engine.calculateGraduatedPayments({ ...commonParams, growthRate });
                            break;
                        case 'custom':
                            const customPaymentsProcessed = customPayments.map(p => ({
                                type: p.type,
                                amount: p.isPercentage ? unitValue * (p.value / 100) : p.value,
                                frequency: p.frequency,
                                numberOfPayments: p.numberOfPayments,
                                startDate: p.startDate
                            }));
                            result = engine.calculateCustomDistribution({
                                downPayment,
                                customPayments: customPaymentsProcessed,
                                quarterlyYears: customQuarterlyYears,
                                quarterlyStartDate: customQuarterlyStartDate || null,
                                installmentDay: installmentDay,
                                remainingFrequency: customRemainingFrequency
                            });
                            break;
                    }

                    // تطبيق التقريب التلقائي (لأقرب 100 ج) على الأقساط الدورية 
                    let finalSchedule;
                    
                    if (selectedPattern === 'equal' && result.distributeUnitValue) {
                        // النظام الأساسي: تقريب مع الحفاظ على الإجمالي = سعر الوحدة
                        finalSchedule = result.schedule.map(payment => {
                            if (payment.type === 'مقدم' || payment.type.includes('دفعة')) return payment;
                            const roundedAmount = Math.ceil(payment.amount / 100) * 100;
                            return { ...payment, amount: roundedAmount, discount: roundedAmount - payment.pv };
                        });
                        
                        // تعديل القسط الأخير ليكون الإجمالي = سعر الوحدة بالضبط
                        const totalBeforeLast = finalSchedule.slice(0, -1).reduce((s, p) => s + p.amount, 0);
                        const lastIdx = finalSchedule.length - 1;
                        const adjustedLast = unitValue - totalBeforeLast;
                        if (adjustedLast > 0 && lastIdx > 0) {
                            finalSchedule[lastIdx] = {
                                ...finalSchedule[lastIdx],
                                amount: adjustedLast,
                                discount: adjustedLast - finalSchedule[lastIdx].pv
                            };
                        }
                        
                        // تطبيق التقريب الإضافي للمدير (مع نفس المنطق)
                        if (isAdmin && roundingOption !== '100') {
                            const roundVal = parseInt(roundingOption);
                            finalSchedule = finalSchedule.map(payment => {
                                if (payment.type === 'مقدم' || payment.type.includes('دفعة')) return payment;
                                const roundedAmount = Math.ceil(payment.amount / roundVal) * roundVal;
                                return { ...payment, amount: roundedAmount, discount: roundedAmount - payment.pv };
                            });
                            const totalBeforeLast2 = finalSchedule.slice(0, -1).reduce((s, p) => s + p.amount, 0);
                            const lastIdx2 = finalSchedule.length - 1;
                            const adjustedLast2 = unitValue - totalBeforeLast2;
                            if (adjustedLast2 > 0 && lastIdx2 > 0) {
                                finalSchedule[lastIdx2] = {
                                    ...finalSchedule[lastIdx2],
                                    amount: adjustedLast2,
                                    discount: adjustedLast2 - finalSchedule[lastIdx2].pv
                                };
                            }
                        }
                    } else {
                        // الأنظمة الأخرى: تقريب عادي
                        finalSchedule = applyAutoRoundingToSchedule(result.schedule);
                        if (isAdmin && roundingOption !== '100') {
                            finalSchedule = applyRoundingToSchedule(finalSchedule, roundingOption);
                        }
                    }
                    
                    // إعادة حساب الملخص والتحقق بناءً على الجدول المقرب
                    const engineForVerification = new SmartPaymentEngine(
                        unitValue, 
                        project.cashDiscountRate, 
                        project.discountRate, 
                        new Date()
                    );
                    
                    result.schedule = finalSchedule;
                    result.summary = engineForVerification.calculateSummary(finalSchedule);
                    // Pass frequency for equal/custom patterns (annuity-based verification)
                    const verifyFreq = (selectedPattern === 'equal' || selectedPattern === 'custom') ? frequency : null;
                    result.verification = engineForVerification.verifyScheduleXNPV(finalSchedule, verifyFreq);

                    setResults(result);

                    // حفظ الحساب في قاعدة البيانات SQLite
                    saveCalculationToDB(result, project.id);

                    // حساب النظام الأساسي للمقارنة
                    if (project.baseSystem) {
                        const baseEngine = new SmartPaymentEngine(
                            unitValue, 
                            project.cashDiscountRate, 
                            project.discountRate, 
                            new Date()
                        );
                        let baseResult = baseEngine.calculateBaseSystem(project.baseSystem, unitValue);

                        // النظام الأساسي: التقريب مع الحفاظ على الإجمالي = سعر الوحدة
                        let baseFinalSchedule = baseResult.schedule.map((payment, idx) => {
                            // لا نقرّب المقدم والدفعات المعروفة (نسب من سعر الوحدة)
                            if (payment.type === 'مقدم' || payment.type.includes('دفعة')) {
                                return payment;
                            }
                            // تقريب الأقساط لأقرب 100
                            const roundedAmount = Math.ceil(payment.amount / 100) * 100;
                            return { ...payment, amount: roundedAmount, discount: roundedAmount - payment.pv };
                        });

                        // تعديل القسط الأخير ليكون الإجمالي = سعر الوحدة بالضبط
                        const baseTotalBeforeLast = baseFinalSchedule.slice(0, -1).reduce((s, p) => s + p.amount, 0);
                        const lastIdx = baseFinalSchedule.length - 1;
                        const adjustedLastAmount = unitValue - baseTotalBeforeLast;
                        if (adjustedLastAmount > 0) {
                            baseFinalSchedule[lastIdx] = {
                                ...baseFinalSchedule[lastIdx],
                                amount: adjustedLastAmount,
                                discount: adjustedLastAmount - baseFinalSchedule[lastIdx].pv
                            };
                        }
                        
                        baseResult.schedule = baseFinalSchedule;
                        baseResult.summary = baseEngine.calculateSummary(baseFinalSchedule);
                        baseResult.verification = baseEngine.verifyScheduleXNPV(baseFinalSchedule, 4); // Base system always quarterly
                        
                        setBaseSystemResults(baseResult);
                    } else {
                        setBaseSystemResults(null);
                    }

                } catch (error) {
                    console.error("Calculation Error:", error);
                    alert(`❌ حدث خطأ في الحساب: ${error.message}`);
                    setResults(null);
                    setBaseSystemResults(null);
                }
            };
            
            // ═══════════════════════════════════════════════════════════════
            // Components
            // ═══════════════════════════════════════════════════════════════

            const ProjectManagerModal = () => (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 print-hidden" onClick={() => setShowProjectsManager(false)}>
                    <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto animate-slide-in" onClick={(e) => e.stopPropagation()}>
                        <div className="bg-gradient-to-r from-gray-900 to-black px-8 py-6 text-white sticky top-0 rounded-t-2xl">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h2 className="text-2xl font-bold">🛠️ إدارة المشاريع</h2>
                                    <p className="text-sm text-gray-400">تعديل بيانات المشاريع ومعدلات الخصم.</p>
                                </div>
                                <button onClick={() => setShowProjectsManager(false)} className="text-gray-400 hover:text-white text-3xl font-light">×</button>
                            </div>
                        </div>
                        <div className="p-8">
                            <div className="flex justify-end mb-6">
                                <button onClick={addProject} className="btn-premium gradient-info text-white px-6 py-2 rounded-xl text-lg flex items-center gap-2">
                                    ➕ إضافة مشروع جديد
                                </button>
                            </div>
                            <div className="space-y-4">
                                {projects.map(project => (
                                    <div key={project.id} className="glass-dark p-4 rounded-xl shadow-lg border-2 border-red-100">
                                        {editingProject === project.id ? (
                                            <div className="space-y-3">
                                                <input
                                                    type="text"
                                                    value={project.name}
                                                    onChange={(e) => updateProject(project.id, 'name', e.target.value)}
                                                    className="w-full px-3 py-2 border rounded-lg modern-input text-lg font-bold"
                                                    placeholder="اسم المشروع"
                                                />
                                                <input
                                                    type="text"
                                                    value={project.description}
                                                    onChange={(e) => updateProject(project.id, 'description', e.target.value)}
                                                    className="w-full px-3 py-2 border rounded-lg modern-input text-sm"
                                                    placeholder="وصف المشروع"
                                                />
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="text-sm font-medium text-gray-700">خصم الكاش (%)</label>
                                                        <input
                                                            type="number"
                                                            step="0.001"
                                                            value={project.cashDiscountRate}
                                                            onChange={(e) => updateProject(project.id, 'cashDiscountRate', parseFloat(e.target.value) || 0)}
                                                            className="w-full px-3 py-2 border rounded-lg modern-input"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="text-sm font-medium text-gray-700">معدل الخصم المُعتمد (%)</label>
                                                        <input
                                                            type="number"
                                                            step="0.001"
                                                            value={project.discountRate}
                                                            onChange={(e) => updateProject(project.id, 'discountRate', parseFloat(e.target.value) || 0)}
                                                            className="w-full px-3 py-2 border rounded-lg modern-input"
                                                            disabled={project.discountRateMode === 'auto'}
                                                        />
                                                        <span className="text-xs text-gray-500 block mt-1">
                                                            {project.discountRateMode === 'auto' ? 'تم حسابه تلقائياً من النظام الأساسي' : 'يدوي'}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="text-sm font-medium text-gray-700">الحد الأدنى للمقدم (%)</label>
                                                        <input
                                                            type="number"
                                                            step="1"
                                                            value={project.minDownPaymentPercent}
                                                            onChange={(e) => updateProject(project.id, 'minDownPaymentPercent', parseFloat(e.target.value) || 0)}
                                                            className="w-full px-3 py-2 border rounded-lg modern-input"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="text-sm font-medium text-gray-700">الحد الأقصى لسنوات التقسيط</label>
                                                        <input
                                                            type="number"
                                                            step="1"
                                                            value={project.maxInstallmentYears}
                                                            onChange={(e) => updateProject(project.id, 'maxInstallmentYears', parseInt(e.target.value) || 0)}
                                                            className="w-full px-3 py-2 border rounded-lg modern-input"
                                                        />
                                                    </div>
                                                </div>
                                                <div className="flex justify-end gap-3 mt-4">
                                                    <button 
                                                        onClick={() => {
                                                            setCurrentProjectForBaseSystem(project);
                                                            setTempBaseSystem(project.baseSystem || {});
                                                            setShowBaseSystemModal(true);
                                                        }}
                                                        className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm"
                                                    >
                                                        🧮 تعديل النظام الأساسي
                                                    </button>
                                                    <button onClick={() => setEditingProject(null)} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                                                        حفظ
                                                    </button>
                                                    <button onClick={() => deleteProject(project.id)} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">
                                                        حذف
                                                    </button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="flex justify-between items-center">
                                                <div>
                                                    <h3 className="font-bold text-xl text-gray-900">{project.name}</h3>
                                                    <p className="text-sm text-gray-700">{project.description}</p>
                                                    <div className="flex gap-4 text-xs mt-2 text-gray-600">
                                                        <span>خصم كاش: <span className="font-bold text-red-600">{project.cashDiscountRate}%</span></span>
                                                        <span>معدل خصم: <span className="font-bold text-blue-600">{project.discountRate.toFixed(3)}%</span></span>
                                                        <span>حد أدنى للمقدم: <span className="font-bold text-green-600">{project.minDownPaymentPercent}%</span></span>
                                                    </div>
                                                </div>
                                                <button onClick={() => setEditingProject(project.id)} className="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm">
                                                    تعديل
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
            
            const BaseSystemModal = () => (
                showBaseSystemModal && currentProjectForBaseSystem && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 print-hidden" onClick={() => setShowBaseSystemModal(false)}>
                        <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto animate-slide-in" onClick={(e) => e.stopPropagation()}>
                            <div className="bg-gradient-to-r from-gray-900 to-black px-8 py-6 text-white sticky top-0 rounded-t-2xl">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h2 className="text-2xl font-bold">🧮 تعديل النظام الأساسي</h2>
                                        <p className="text-sm text-gray-400">المشروع: {currentProjectForBaseSystem.name} | <span className="text-yellow-400">قيمة الوحدة: {formatCurrency(unitValue)}</span></p>
                                    </div>
                                    <button onClick={() => setShowBaseSystemModal(false)} className="text-gray-400 hover:text-white text-3xl font-light">×</button>
                                </div>
                            </div>
                            <div className="p-8 space-y-6">
                                {/* المقدم */}
                                <div className="p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                                    <h3 className="font-bold text-lg text-gray-800 mb-2">المقدم</h3>
                                    <div className="grid grid-cols-3 gap-4">
                                        <input
                                            type="number"
                                            step="0.01"
                                            value={tempBaseSystem.downPaymentValue || ''}
                                            onChange={(e) => setTempBaseSystem({ ...tempBaseSystem, downPaymentValue: parseFloat(e.target.value) || 0 })}
                                            className="px-3 py-2 border rounded-lg modern-input col-span-2"
                                            placeholder="قيمة المقدم"
                                        />
                                        <select
                                            value={tempBaseSystem.downPaymentIsPercentage ? 'percentage' : 'value'}
                                            onChange={(e) => setTempBaseSystem({ ...tempBaseSystem, downPaymentIsPercentage: e.target.value === 'percentage' })}
                                            className="px-3 py-2 border rounded-lg modern-input bg-white"
                                        >
                                            <option value="percentage">نسبة %</option>
                                            <option value="value">قيمة ج</option>
                                        </select>
                                    </div>
                                    <input
                                        type="date"
                                        value={tempBaseSystem.downPaymentDate || ''}
                                        onChange={(e) => setTempBaseSystem({ ...tempBaseSystem, downPaymentDate: e.target.value })}
                                        className="w-full px-3 py-2 border rounded-lg modern-input mt-3 bg-white"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">تاريخ دفع المقدم (اختياري)</p>
                                </div>

                                {/* الدفعات السنوية */}
                                <div className="p-4 bg-green-50 rounded-lg border-2 border-green-200">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-lg text-gray-800">الدفعات السنوية (Annual Payments)</h3>
                                        <button onClick={() => {
                                            const newPayment = { value: 10, isPercentage: true, type: `دفعة سنوية ${tempBaseSystem.annualPayments.length + 1}`, date: null };
                                            setTempBaseSystem({ ...tempBaseSystem, annualPayments: [...(tempBaseSystem.annualPayments || []), newPayment] });
                                        }} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                                            ➕ إضافة
                                        </button>
                                    </div>
                                    <div className="space-y-3">
                                        {(tempBaseSystem.annualPayments || []).map((p, index) => (
                                            <div key={index} className="flex gap-3 items-center bg-white p-3 rounded-lg border border-green-300">
                                                <input
                                                    type="text"
                                                    value={p.type}
                                                    onChange={(e) => {
                                                        const updated = [...tempBaseSystem.annualPayments];
                                                        updated[index].type = e.target.value;
                                                        setTempBaseSystem({ ...tempBaseSystem, annualPayments: updated });
                                                    }}
                                                    className="w-32 px-3 py-2 border rounded-lg modern-input"
                                                />
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={p.value || ''}
                                                    onChange={(e) => {
                                                        const updated = [...tempBaseSystem.annualPayments];
                                                        updated[index].value = parseFloat(e.target.value) || 0;
                                                        setTempBaseSystem({ ...tempBaseSystem, annualPayments: updated });
                                                    }}
                                                    className="w-24 px-3 py-2 border rounded-lg modern-input"
                                                    placeholder="قيمة"
                                                />
                                                <select
                                                    value={p.isPercentage ? 'percentage' : 'value'}
                                                    onChange={(e) => {
                                                        const updated = [...tempBaseSystem.annualPayments];
                                                        updated[index].isPercentage = e.target.value === 'percentage';
                                                        setTempBaseSystem({ ...tempBaseSystem, annualPayments: updated });
                                                    }}
                                                    className="px-3 py-2 border rounded-lg modern-input bg-white"
                                                >
                                                    <option value="percentage">نسبة %</option>
                                                    <option value="value">قيمة ج</option>
                                                </select>
                                                <input
                                                    type="date"
                                                    value={p.date || ''}
                                                    onChange={(e) => {
                                                        const updated = [...tempBaseSystem.annualPayments];
                                                        updated[index].date = e.target.value;
                                                        setTempBaseSystem({ ...tempBaseSystem, annualPayments: updated });
                                                    }}
                                                    className="w-40 px-3 py-2 border rounded-lg modern-input bg-white"
                                                />
                                                <button onClick={() => {
                                                    const updated = tempBaseSystem.annualPayments.filter((_, i) => i !== index);
                                                    setTempBaseSystem({ ...tempBaseSystem, annualPayments: updated });
                                                }} className="text-red-600 hover:text-red-800 text-xl font-bold">
                                                    ×
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* الدفعات النصف سنوية */}
                                <div className="p-4 bg-yellow-50 rounded-lg border-2 border-yellow-200">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-lg text-gray-800">الدفعات النصف سنوية (Semiannual Payments)</h3>
                                        <button onClick={() => {
                                            const newPayment = { value: 5, isPercentage: true, type: `دفعة نصف سنوية ${tempBaseSystem.semiannualPayments.length + 1}`, date: null };
                                            setTempBaseSystem({ ...tempBaseSystem, semiannualPayments: [...(tempBaseSystem.semiannualPayments || []), newPayment] });
                                        }} className="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm">
                                            ➕ إضافة
                                        </button>
                                    </div>
                                    {/* ... نفس حقول الإدخال للإجراءات النصف سنوية ... */}
                                    <div className="space-y-3">
                                        {(tempBaseSystem.semiannualPayments || []).map((p, index) => (
                                            <div key={index} className="flex gap-3 items-center bg-white p-3 rounded-lg border border-yellow-300">
                                                <input
                                                    type="text"
                                                    value={p.type}
                                                    onChange={(e) => {
                                                        const updated = [...tempBaseSystem.semiannualPayments];
                                                        updated[index].type = e.target.value;
                                                        setTempBaseSystem({ ...tempBaseSystem, semiannualPayments: updated });
                                                    }}
                                                    className="w-32 px-3 py-2 border rounded-lg modern-input"
                                                />
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={p.value || ''}
                                                    onChange={(e) => {
                                                        const updated = [...tempBaseSystem.semiannualPayments];
                                                        updated[index].value = parseFloat(e.target.value) || 0;
                                                        setTempBaseSystem({ ...tempBaseSystem, semiannualPayments: updated });
                                                    }}
                                                    className="w-24 px-3 py-2 border rounded-lg modern-input"
                                                    placeholder="قيمة"
                                                />
                                                <select
                                                    value={p.isPercentage ? 'percentage' : 'value'}
                                                    onChange={(e) => {
                                                        const updated = [...tempBaseSystem.semiannualPayments];
                                                        updated[index].isPercentage = e.target.value === 'percentage';
                                                        setTempBaseSystem({ ...tempBaseSystem, semiannualPayments: updated });
                                                    }}
                                                    className="px-3 py-2 border rounded-lg modern-input bg-white"
                                                >
                                                    <option value="percentage">نسبة %</option>
                                                    <option value="value">قيمة ج</option>
                                                </select>
                                                <input
                                                    type="date"
                                                    value={p.date || ''}
                                                    onChange={(e) => {
                                                        const updated = [...tempBaseSystem.semiannualPayments];
                                                        updated[index].date = e.target.value;
                                                        setTempBaseSystem({ ...tempBaseSystem, semiannualPayments: updated });
                                                    }}
                                                    className="w-40 px-3 py-2 border rounded-lg modern-input bg-white"
                                                />
                                                <button onClick={() => {
                                                    const updated = tempBaseSystem.semiannualPayments.filter((_, i) => i !== index);
                                                    setTempBaseSystem({ ...tempBaseSystem, semiannualPayments: updated });
                                                }} className="text-red-600 hover:text-red-800 text-xl font-bold">
                                                    ×
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* الدفعات الربع سنوية المحددة */}
                                <div className="p-4 bg-red-50 rounded-lg border-2 border-red-200">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-lg text-gray-800">الدفعات الربع سنوية المحددة (Quarterly Payments)</h3>
                                        <button onClick={() => {
                                            const newPayment = { value: 2.5, isPercentage: true, type: `دفعة ربع سنوية ${tempBaseSystem.quarterlyPayments.length + 1}`, date: null };
                                            setTempBaseSystem({ ...tempBaseSystem, quarterlyPayments: [...(tempBaseSystem.quarterlyPayments || []), newPayment] });
                                        }} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">
                                            ➕ إضافة
                                        </button>
                                    </div>
                                    <div className="space-y-3">
                                        {(tempBaseSystem.quarterlyPayments || []).map((p, index) => (
                                            <div key={index} className="flex gap-3 items-center bg-white p-3 rounded-lg border border-red-300">
                                                <input
                                                    type="text"
                                                    value={p.type}
                                                    onChange={(e) => {
                                                        const updated = [...tempBaseSystem.quarterlyPayments];
                                                        updated[index].type = e.target.value;
                                                        setTempBaseSystem({ ...tempBaseSystem, quarterlyPayments: updated });
                                                    }}
                                                    className="w-32 px-3 py-2 border rounded-lg modern-input"
                                                />
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={p.value || ''}
                                                    onChange={(e) => {
                                                        const updated = [...tempBaseSystem.quarterlyPayments];
                                                        updated[index].value = parseFloat(e.target.value) || 0;
                                                        setTempBaseSystem({ ...tempBaseSystem, quarterlyPayments: updated });
                                                    }}
                                                    className="w-24 px-3 py-2 border rounded-lg modern-input"
                                                    placeholder="قيمة"
                                                />
                                                <select
                                                    value={p.isPercentage ? 'percentage' : 'value'}
                                                    onChange={(e) => {
                                                        const updated = [...tempBaseSystem.quarterlyPayments];
                                                        updated[index].isPercentage = e.target.value === 'percentage';
                                                        setTempBaseSystem({ ...tempBaseSystem, quarterlyPayments: updated });
                                                    }}
                                                    className="px-3 py-2 border rounded-lg modern-input bg-white"
                                                >
                                                    <option value="percentage">نسبة %</option>
                                                    <option value="value">قيمة ج</option>
                                                </select>
                                                <input
                                                    type="date"
                                                    value={p.date || ''}
                                                    onChange={(e) => {
                                                        const updated = [...tempBaseSystem.quarterlyPayments];
                                                        updated[index].date = e.target.value;
                                                        setTempBaseSystem({ ...tempBaseSystem, quarterlyPayments: updated });
                                                    }}
                                                    className="w-40 px-3 py-2 border rounded-lg modern-input bg-white"
                                                />
                                                <button onClick={() => {
                                                    const updated = tempBaseSystem.quarterlyPayments.filter((_, i) => i !== index);
                                                    setTempBaseSystem({ ...tempBaseSystem, quarterlyPayments: updated });
                                                }} className="text-red-600 hover:text-red-800 text-xl font-bold">
                                                    ×
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* سنوات التقسيط المتبقية */}
                                <div className="p-4 bg-indigo-50 rounded-lg border-2 border-indigo-200">
                                    <h3 className="font-bold text-lg text-gray-800 mb-2">سنوات تقسيط باقي الثمن (أقساط ربع سنوية موحدة)</h3>
                                    <input
                                        type="number"
                                        step="0.25"
                                        value={tempBaseSystem.quarterlyYears || ''}
                                        onChange={(e) => setTempBaseSystem({ ...tempBaseSystem, quarterlyYears: parseFloat(e.target.value) || 0 })}
                                        className="w-full px-3 py-2 border rounded-lg modern-input"
                                        placeholder="عدد السنوات (مثال: 8, 4, 0.25)"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">يجب أن تكون هذه السنوات هي المتبقية لتقسيط باقي القيمة الإجمالية.</p>
                                </div>

                                <div className="flex justify-end gap-3 pt-4 border-t">
                                    <button onClick={() => setShowBaseSystemModal(false)} className="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-xl text-lg">
                                        إلغاء
                                    </button>
                                    <button onClick={calculateBaseSystemImpliedRate} className="btn-premium gradient-info text-white px-6 py-2 rounded-xl text-lg flex items-center gap-2">
                                        💾 حفظ وحساب معدل الخصم
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            );

            const ComparisonModal = () => (
                showComparison && baseSystemResults && results && (
                    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 print-hidden" onClick={() => setShowComparison(false)}>
                        <div className="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto animate-slide-in" onClick={(e) => e.stopPropagation()}>
                            <div className="bg-gradient-to-r from-red-600 to-red-800 px-8 py-6 text-white sticky top-0 rounded-t-2xl">
                                <div className="flex items-center justify-between">
                                    <h2 className="text-2xl font-bold">🆚 مقارنة متقدمة لخطط السداد</h2>
                                    <button onClick={() => setShowComparison(false)} className="text-gray-200 hover:text-white text-3xl font-light">×</button>
                                </div>
                                <p className="text-sm text-gray-200 mt-1">المشروع: {getSelectedProject().name} | الوحدة: {unitNumber || 'غير محدد'} | القيمة: {formatCurrency(unitValue)}</p>
                            </div>
                            <div className="p-8">
                                <h3 className="text-xl font-bold text-gray-800 mb-4">ملخص المقارنة المالية</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                    <div className="bg-white rounded-lg p-4 shadow border border-gray-200">
                                        <p className="text-sm text-gray-600 mb-1">فرق المقدم</p>
                                        <p className={`text-xl font-bold ${results.downPayment > baseSystemResults.downPayment ? 'text-green-600' : 'text-red-600'}`}>
                                            {formatCurrency(Math.abs(results.downPayment - baseSystemResults.downPayment))}
                                        </p>
                                        <p className="text-xs text-gray-500 mt-1">
                                            {results.downPayment > baseSystemResults.downPayment ? '↑ أعلى' : '↓ أقل'}
                                        </p>
                                    </div>
                                    <div className="bg-white rounded-lg p-4 shadow border border-gray-200">
                                        <p className="text-sm text-gray-600 mb-1">فرق عدد الدفعات</p>
                                        <p className={`text-xl font-bold ${(results.schedule.length - 1) < (baseSystemResults.schedule.length - 1) ? 'text-green-600' : 'text-red-600'}`}>
                                            {Math.abs((results.schedule.length - 1) - (baseSystemResults.schedule.length - 1))}
                                        </p>
                                        <p className="text-xs text-gray-500 mt-1">
                                            {(results.schedule.length - 1) < (baseSystemResults.schedule.length - 1) ? 'أقل دفعات' : 'أكثر دفعات'}
                                        </p>
                                    </div>
                                    <div className="bg-white rounded-lg p-4 shadow border border-gray-200">
                                        <p className="text-sm text-gray-600 mb-1">فرق الإجمالي</p>
                                        <p className={`text-xl font-bold ${results.summary.totalPaid < baseSystemResults.summary.totalPaid ? 'text-green-600' : 'text-red-600'}`}>
                                            {formatCurrency(Math.abs(results.summary.totalPaid - baseSystemResults.summary.totalPaid))}
                                        </p>
                                        <p className="text-xs text-gray-500 mt-1">
                                            {results.summary.totalPaid < baseSystemResults.summary.totalPaid ? '↓ أقل إجمالي' : '↑ أعلى إجمالي'}
                                        </p>
                                    </div>
                                    <div className="bg-white rounded-lg p-4 shadow border border-gray-200">
                                        <p className="text-sm text-gray-600 mb-1">فرق القيمة الحالية (PV)</p>
                                        <p className={`text-xl font-bold ${results.summary.totalPV > baseSystemResults.summary.totalPV ? 'text-green-600' : 'text-red-600'}`}>
                                            {formatCurrency(Math.abs(results.summary.totalPV - baseSystemResults.summary.totalPV))}
                                        </p>
                                        <p className="text-xs text-gray-500 mt-1">
                                            {results.summary.totalPV > baseSystemResults.summary.totalPV ? '↑ أقرب للكاش' : '↓ أبعد عن الكاش'}
                                        </p>
                                    </div>
                                </div>
                                
                                <h3 className="text-xl font-bold text-gray-800 mb-4">جدول مقارنة الدفعات</h3>
                                <div className="overflow-x-auto">
                                    <table className="min-w-full bg-white comparison-table rounded-xl shadow-lg">
                                        <thead>
                                            <tr className="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                                <th className="py-3 px-6 text-right">#</th>
                                                <th className="py-3 px-6 text-right">تاريخ الدفعة</th>
                                                <th className="py-3 px-6 text-right font-bold text-red-700">دفعة مقترحة ({results.patternName})</th>
                                                <th className="py-3 px-6 text-right font-bold text-blue-700">دفعة النظام الأساسي</th>
                                                <th className="py-3 px-6 text-right">فرق الدفعة</th>
                                            </tr>
                                        </thead>
                                        <tbody className="text-gray-700 text-sm font-light">
                                            {results.schedule.map((p, index) => {
                                                const basePayment = baseSystemResults.schedule.find(bp => 
                                                    bp.type === p.type && (p.type === 'مقدم' || bp.id === p.id)
                                                ) || null;
                                                
                                                let baseAmount = basePayment?.amount || 0;
                                                let diff = p.amount - baseAmount;
                                                let diffClass = diff > 0 ? 'text-red-600 font-bold' : (diff < 0 ? 'text-green-600 font-bold' : '');

                                                return (
                                                    <tr key={index} className="border-b border-gray-200 hover:bg-gray-50">
                                                        <td className="py-3 px-6 text-right whitespace-nowrap">{p.id} - {p.type}</td>
                                                        <td className="py-3 px-6 text-right">{formatDate(p.date)}</td>
                                                        <td className="py-3 px-6 text-right font-bold text-red-800">{formatCurrency(p.amount)}</td>
                                                        <td className="py-3 px-6 text-right font-bold text-blue-800">{formatCurrency(baseAmount)}</td>
                                                        <td className={`py-3 px-6 text-right ${diffClass}`}>
                                                            {formatCurrency(diff)}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                            {/* صف الإجمالي */}
                                            <tr className="bg-gray-200 font-bold text-base">
                                                <td className="py-3 px-6 text-right">الإجمالي</td>
                                                <td className="py-3 px-6 text-right"></td>
                                                <td className="py-3 px-6 text-right text-red-800">{formatCurrency(results.summary.totalPaid)}</td>
                                                <td className="py-3 px-6 text-right text-blue-800">{formatCurrency(baseSystemResults.summary.totalPaid)}</td>
                                                <td className={`py-3 px-6 text-right ${results.summary.totalPaid < baseSystemResults.summary.totalPaid ? 'text-green-600' : 'text-red-600'}`}>
                                                    {formatCurrency(results.summary.totalPaid - baseSystemResults.summary.totalPaid)}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div className="flex justify-center mt-6">
                                    <button onClick={() => setShowComparison(false)} className="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-xl text-lg">
                                        إغلاق
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            );

            // ═══════════════════════════════════════════════════════════════
            // Main Render
            // ═══════════════════════════════════════════════════════════════

            return (
                <div className="min-h-screen p-4 md:p-8 bg-gray-100">
                    <div className="max-w-7xl mx-auto">
                        
                        {/* Header Section */}
                        <div className="glass-card gradient-dark p-8 text-white relative overflow-hidden print-hidden border-t-4 border-red-600">
                            <div className="absolute top-0 left-0 w-64 h-64 bg-red-600/10 rounded-full -translate-x-32 -translate-y-32"></div>
                            <div className="absolute bottom-0 right-0 w-96 h-96 bg-red-600/10 rounded-full translate-x-48 translate-y-48"></div>
                            <div className="relative z-10">
                                <div className="flex items-center justify-between mb-4">
                                    <div>
                                        <h1 className="text-4xl font-bold mb-2">🏢 نظام التقسيط المرن</h1>
                                        <p className="text-gray-300 text-lg">BETA SMART FINANCE | شركة بيتا للتطوير العقاري <span className="text-red-500 font-bold">SINCE 1993</span></p>
                                    </div>
                                    <button onClick={() => isAdmin ? setIsAdmin(false) : setShowAdminPanel(true)} className="bg-red-600/80 hover:bg-red-600 px-6 py-3 rounded-xl backdrop-blur-lg transition">
                                        {isAdmin ? '🔒 خروج المدير' : '⚙️ دخول المدير'}
                                    </button>
                                </div>
                                {isAdmin && (
                                    <div className="mt-4 flex items-center gap-4">
                                        <span className="badge badge-pro">PRO MODE</span>
                                        <button onClick={() => setShowProjectsManager(true)} className="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg text-sm transition">
                                            ⚙️ إدارة المشاريع
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Admin Login Panel */}
                        {showAdminPanel && (
                            <div className="glass-card bg-white p-6 mt-4 rounded-xl shadow-lg print-hidden animate-fade-in">
                                <h3 className="font-bold text-gray-800 mb-3">تسجيل دخول المدير</h3>
                                <div className="flex gap-3">
                                    <input 
                                        type="password" 
                                        value={adminPassword} 
                                        onChange={(e) => setAdminPassword(e.target.value)}
                                        placeholder="كلمة المرور"
                                        className="flex-1 modern-input px-4 py-2"
                                    />
                                    <button onClick={handleAdminLogin} className="btn-premium gradient-dark text-white px-6 py-2 rounded-lg">
                                        دخول
                                    </button>
                                </div>
                            </div>
                        )}
                        
                        {/* Project Manager Modal */}
                        {showProjectsManager && isAdmin && <ProjectManagerModal />}

                        {/* Base System Modal */}
                        <BaseSystemModal />

                        {/* Main Content Area */}
                        <div className="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                            
                            {/* Input Panel - Col 1 */}
                            <div className="lg:col-span-1 space-y-6 print-hidden">
                                
                                {/* Project Selector */}
                                <div className="glass-card p-6 rounded-xl shadow-lg space-y-4">
                                    <h3 className="text-xl font-bold text-gray-800 mb-4">اختر المشروع</h3>
                                    <div className="grid grid-cols-1 gap-4">
                                        {projects.map(project => (
                                            <button 
                                                key={project.id} 
                                                onClick={() => setSelectedProjectId(project.id)}
                                                className={`p-4 rounded-xl border-2 transition-all text-right ${
                                                    selectedProjectId === project.id ? 'border-red-600 bg-red-50 shadow-md' : 'bg-white border-gray-300 hover:border-red-400'
                                                }`}
                                            >
                                                <h3 className="font-bold text-lg text-gray-800 mb-1">{project.name}</h3>
                                                <p className="text-sm text-gray-600 mb-2">{project.description}</p>
                                                <div className="text-xs text-gray-500 space-y-1">
                                                    <div className="bg-gray-100 px-2 py-1 rounded">خصم كاش: {project.cashDiscountRate}%</div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Unit & Pattern Input */}
                                <div className="glass-card p-6 rounded-xl shadow-lg space-y-4">
                                    <h3 className="text-xl font-bold text-gray-800 mb-4">تفاصيل الوحدة وخطة السداد</h3>
                                    
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">قيمة الوحدة (ج)</label>
                                        <input
                                            type="number"
                                            step="1000"
                                            value={unitValue}
                                            onChange={(e) => setUnitValue(parseFloat(e.target.value) || 0)}
                                            className="w-full modern-input px-4 py-2 text-lg font-bold"
                                            placeholder="مثال: 1,500,000"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">رقم الوحدة / اسم العميل</label>
                                        <input
                                            type="text"
                                            value={unitNumber}
                                            onChange={(e) => setUnitNumber(e.target.value)}
                                            className="w-full modern-input px-4 py-2"
                                            placeholder="مثال: A-101 / السيد أحمد"
                                        />
                                    </div>

                                    {/* Payment Pattern Selector */}
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">نوع نظام التقسيط</label>
                                        <div className="grid grid-cols-2 gap-3">
                                            {patterns.map(pattern => (
                                                <button 
                                                    key={pattern.id}
                                                    onClick={() => setSelectedPattern(pattern.id)}
                                                    className={`p-4 rounded-xl border-2 transition-all text-right ${
                                                        selectedPattern === pattern.id ? `border-${pattern.color}-600 bg-${pattern.color}-50 shadow-md` : 'bg-white border-gray-300 hover:border-red-400'
                                                    }`}
                                                >
                                                    <p className="text-xl font-bold mb-1">{pattern.icon} {pattern.name}</p>
                                                    <p className="text-xs text-gray-500">{pattern.description}</p>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Payment Details & Results - Col 2 & 3 */}
                            <div className="lg:col-span-2 space-y-6">
                                
                                {/* Dynamic Input Panel */}
                                <div className="glass-card p-6 rounded-xl shadow-lg animate-fade-in print-hidden">
                                    <h3 className="text-xl font-bold text-gray-800 mb-4">تكوين نظام السداد المقترح</h3>

                                    {/* Down Payment & Installment Day */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                        <div className="p-4 bg-red-50 rounded-lg border-2 border-red-200">
                                            <label className="block text-sm font-bold text-gray-700 mb-2">قيمة المقدم</label>
                                            <div className="flex gap-3">
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={downPaymentValue}
                                                    onChange={(e) => setDownPaymentValue(parseFloat(e.target.value) || 0)}
                                                    className="flex-1 modern-input px-4 py-2"
                                                    placeholder="القيمة"
                                                />
                                                <select
                                                    value={downPaymentIsPercentage ? 'percentage' : 'value'}
                                                    onChange={(e) => setDownPaymentIsPercentage(e.target.value === 'percentage')}
                                                    className="px-4 py-2 border rounded-lg modern-input bg-white"
                                                >
                                                    <option value="percentage">نسبة %</option>
                                                    <option value="value">قيمة ج</option>
                                                </select>
                                            </div>
                                            {unitValue > 0 && calculateDownPayment() < (unitValue * (getSelectedProject().minDownPaymentPercent / 100)) && (
                                                <div className="mt-2 p-2 bg-red-100 rounded">
                                                    <p className="text-red-700 text-xs"> ⚠️ المقدم لا يمكن أن يقل عن {getSelectedProject().minDownPaymentPercent || 5}% لهذا المشروع </p>
                                                    <p className="text-red-600 text-xs mt-1"> النسبة الحالية: {(downPaymentIsPercentage ? downPaymentValue : (downPaymentValue / unitValue) * 100).toFixed(2)}% | الحد الأدنى المطلوب: {formatCurrency(unitValue * (getSelectedProject().minDownPaymentPercent || 5) / 100)} </p>
                                                </div>
                                            )}
                                        </div>

                                        <div className="p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                                            <label className="block text-sm font-bold text-gray-700 mb-2">يوم استحقاق القسط</label>
                                            <div className="flex gap-3">
                                                <label className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg cursor-pointer transition-all border-2 ${installmentDay === 1 ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-gray-300 hover:border-blue-400'}`}>
                                                    <input type="radio" name="installmentDayCustom" value="1" checked={installmentDay === 1} onChange={() => setInstallmentDay(1)} className="hidden" />
                                                    <span className="font-bold">يوم 1</span>
                                                </label>
                                                <label className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg cursor-pointer transition-all border-2 ${installmentDay === 15 ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-gray-300 hover:border-blue-400'}`}>
                                                    <input type="radio" name="installmentDayCustom" value="15" checked={installmentDay === 15} onChange={() => setInstallmentDay(15)} className="hidden" />
                                                    <span className="font-bold">يوم 15</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Inputs for Equal, Decreasing, Graduated */}
                                    {(selectedPattern === 'equal' || selectedPattern === 'decreasing' || selectedPattern === 'graduated') && (
                                        <div className="p-4 bg-gray-50 rounded-lg border-2 border-gray-200 space-y-4">
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                {/* Number of Years */}
                                                <div>
                                                    <label className="block text-sm font-bold text-gray-700 mb-1">مدة الأقساط (سنوات)</label>
                                                    <input
                                                        type="number"
                                                        step="1"
                                                        value={numberOfYears}
                                                        onChange={(e) => setNumberOfYears(parseInt(e.target.value) || 0)}
                                                        className="w-full modern-input px-4 py-2"
                                                        placeholder="عدد السنوات"
                                                    />
                                                </div>

                                                {/* Frequency */}
                                                <div>
                                                    <label className="block text-sm font-bold text-gray-700 mb-1">تردد القسط</label>
                                                    <select
                                                        value={frequency}
                                                        onChange={(e) => setFrequency(parseInt(e.target.value))}
                                                        className="w-full modern-input px-4 py-2 bg-white"
                                                    >
                                                        <option value={12}>شهري (12)</option>
                                                        <option value={4}>ربع سنوي (4)</option>
                                                        <option value={2}>نصف سنوي (2)</option>
                                                        <option value={1}>سنوي (1)</option>
                                                    </select>
                                                </div>

                                                {/* Growth/Decrease Rate */}
                                                {(selectedPattern === 'decreasing' || selectedPattern === 'graduated') && (
                                                    <div>
                                                        <label className="block text-sm font-bold text-gray-700 mb-1">
                                                            {selectedPattern === 'decreasing' ? 'نسبة التناقص السنوية (%)' : 'نسبة التزايد السنوية (%)'}
                                                        </label>
                                                        <input
                                                            type="number"
                                                            step="0.01"
                                                            value={selectedPattern === 'decreasing' ? decreaseRate : growthRate}
                                                            onChange={(e) => {
                                                                if (selectedPattern === 'decreasing') setDecreaseRate(parseFloat(e.target.value) || 0);
                                                                else setGrowthRate(parseFloat(e.target.value) || 0);
                                                            }}
                                                            className="w-full modern-input px-4 py-2"
                                                            placeholder="النسبة %"
                                                        />
                                                    </div>
                                                )}
                                            </div>

                                            {/* Quarterly Start Date - Optional */}
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-1">تاريخ أول قسط (اختياري)</label>
                                                <input
                                                    type="date"
                                                    value={quarterlyStartDate}
                                                    onChange={(e) => setQuarterlyStartDate(e.target.value)}
                                                    className="w-full modern-input px-4 py-2 bg-white"
                                                    placeholder="تاريخ أول قسط"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">يترك فارغاً لحساب التاريخ تلقائياً بعد {12/frequency} أشهر من تاريخ اليوم</p>
                                            </div>

                                            {/* Additional Payments Section */}
                                            <div className="space-y-4">
                                                {/* Annual Payments */}
                                                <div className="p-3 bg-green-100 rounded-lg border border-green-300">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <h4 className="font-bold text-md text-gray-800">دفعات سنوية إضافية</h4>
                                                        <button onClick={addAnnualPayment} className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg text-xs">
                                                            ➕ إضافة
                                                        </button>
                                                    </div>
                                                    {annualPayments.map(p => (
                                                        <div key={p.id} className="flex gap-2 items-center text-sm mt-2 bg-white p-2 rounded border">
                                                            <input type="text" value={p.type} onChange={(e) => updateAnnualPayment(p.id, 'type', e.target.value)} placeholder="اسم الدفعة" className="px-2 py-1 border rounded w-24" />
                                                            <input type="number" value={p.value} onChange={(e) => updateAnnualPayment(p.id, 'value', parseFloat(e.target.value))} placeholder="القيمة" className="px-2 py-1 border rounded w-20" />
                                                            <select value={p.isPercentage ? 'percentage' : 'value'} onChange={(e) => updateAnnualPayment(p.id, 'isPercentage', e.target.value === 'percentage')} className="px-2 py-1 border rounded bg-white w-20">
                                                                <option value="percentage">%</option>
                                                                <option value="value">ج</option>
                                                            </select>
                                                            <input type="date" value={p.date} onChange={(e) => updateAnnualPayment(p.id, 'date', e.target.value)} className="px-2 py-1 border rounded bg-white flex-1" />
                                                            <button onClick={() => deleteAnnualPayment(p.id)} className="text-red-600 hover:text-red-800 text-lg font-bold">×</button>
                                                        </div>
                                                    ))}
                                                </div>

                                                {/* Semiannual Payments */}
                                                <div className="p-3 bg-yellow-100 rounded-lg border border-yellow-300">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <h4 className="font-bold text-md text-gray-800">دفعات نصف سنوية إضافية</h4>
                                                        <button onClick={addSemiannualPayment} className="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded-lg text-xs">
                                                            ➕ إضافة
                                                        </button>
                                                    </div>
                                                    {semiannualPayments.map(p => (
                                                        <div key={p.id} className="flex gap-2 items-center text-sm mt-2 bg-white p-2 rounded border">
                                                            <input type="text" value={p.type} onChange={(e) => updateSemiannualPayment(p.id, 'type', e.target.value)} placeholder="اسم الدفعة" className="px-2 py-1 border rounded w-24" />
                                                            <input type="number" value={p.value} onChange={(e) => updateSemiannualPayment(p.id, 'value', parseFloat(e.target.value))} placeholder="القيمة" className="px-2 py-1 border rounded w-20" />
                                                            <select value={p.isPercentage ? 'percentage' : 'value'} onChange={(e) => updateSemiannualPayment(p.id, 'isPercentage', e.target.value === 'percentage')} className="px-2 py-1 border rounded bg-white w-20">
                                                                <option value="percentage">%</option>
                                                                <option value="value">ج</option>
                                                            </select>
                                                            <input type="date" value={p.date} onChange={(e) => updateSemiannualPayment(p.id, 'date', e.target.value)} className="px-2 py-1 border rounded bg-white flex-1" />
                                                            <button onClick={() => deleteSemiannualPayment(p.id)} className="text-red-600 hover:text-red-800 text-lg font-bold">×</button>
                                                        </div>
                                                    ))}
                                                </div>
                                                
                                                {/* Quarterly Payments (Specific) */}
                                                <div className="p-3 bg-red-100 rounded-lg border border-red-300">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <h4 className="font-bold text-md text-gray-800">دفعات ربع سنوية محددة (غير أقساط دورية)</h4>
                                                        <button onClick={addQuarterlyPayment} className="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-xs">
                                                            ➕ إضافة
                                                        </button>
                                                    </div>
                                                    {quarterlyPayments.map(p => (
                                                        <div key={p.id} className="flex gap-2 items-center text-sm mt-2 bg-white p-2 rounded border">
                                                            <input type="text" value={p.type} onChange={(e) => updateQuarterlyPayment(p.id, 'type', e.target.value)} placeholder="اسم الدفعة" className="px-2 py-1 border rounded w-24" />
                                                            <input type="number" value={p.value} onChange={(e) => updateQuarterlyPayment(p.id, 'value', parseFloat(e.target.value))} placeholder="القيمة" className="px-2 py-1 border rounded w-20" />
                                                            <select value={p.isPercentage ? 'percentage' : 'value'} onChange={(e) => updateQuarterlyPayment(p.id, 'isPercentage', e.target.value === 'percentage')} className="px-2 py-1 border rounded bg-white w-20">
                                                                <option value="percentage">%</option>
                                                                <option value="value">ج</option>
                                                            </select>
                                                            <input type="date" value={p.date} onChange={(e) => updateQuarterlyPayment(p.id, 'date', e.target.value)} className="px-2 py-1 border rounded bg-white flex-1" />
                                                            <button onClick={() => deleteQuarterlyPayment(p.id)} className="text-red-600 hover:text-red-800 text-lg font-bold">×</button>
                                                        </div>
                                                    ))}
                                                </div>

                                            </div>
                                        </div>
                                    )}

                                    {/* Inputs for Custom Distribution */}
                                    {selectedPattern === 'custom' && (
                                        <div className="space-y-6">
                                            <div className="p-4 bg-amber-50 rounded-lg border-2 border-amber-200">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h3 className="font-bold text-lg">دفعات مخصصة</h3>
                                                    <button onClick={addCustomPayment} className="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm">
                                                        ➕ إضافة دفعة
                                                    </button>
                                                </div>
                                                {customPayments.length > 0 && (
                                                    <div className="space-y-3">
                                                        {customPayments.map((payment) => (
                                                            <div key={payment.id} className="bg-white p-3 rounded-lg border border-amber-300">
                                                                <div className="grid grid-cols-1 md:grid-cols-6 gap-3">
                                                                    <input
                                                                        type="text"
                                                                        value={payment.type}
                                                                        onChange={(e) => updateCustomPayment(payment.id, 'type', e.target.value)}
                                                                        placeholder="اسم"
                                                                        className="px-3 py-2 border rounded"
                                                                    />
                                                                    <div className="flex gap-2">
                                                                        <input
                                                                            type="number"
                                                                            value={payment.value}
                                                                            onChange={(e) => updateCustomPayment(payment.id, 'value', parseFloat(e.target.value))}
                                                                            placeholder="القيمة"
                                                                            className="flex-1 px-3 py-2 border rounded"
                                                                        />
                                                                        <select
                                                                            value={payment.isPercentage ? 'percentage' : 'value'}
                                                                            onChange={(e) => updateCustomPayment(payment.id, 'isPercentage', e.target.value === 'percentage')}
                                                                            className="px-3 py-2 border rounded bg-white"
                                                                        >
                                                                            <option value="percentage">نسبة %</option>
                                                                            <option value="value">قيمة ج</option>
                                                                        </select>
                                                                    </div>
                                                                    <select
                                                                        value={payment.frequency}
                                                                        onChange={(e) => updateCustomPayment(payment.id, 'frequency', e.target.value)}
                                                                        className="px-3 py-2 border rounded"
                                                                    >
                                                                        <option value="once">مرة واحدة</option>
                                                                        <option value="quarterly">ربع سنوي (كل 3 شهور)</option>
                                                                        <option value="semiannual">نصف سنوي (كل 6 شهور)</option>
                                                                        <option value="annual">سنوي (كل 12 شهر)</option>
                                                                    </select>
                                                                    {payment.frequency !== 'once' && (
                                                                        <div className="flex items-center">
                                                                            <input
                                                                                type="number"
                                                                                value={payment.numberOfPayments}
                                                                                onChange={(e) => updateCustomPayment(payment.id, 'numberOfPayments', parseInt(e.target.value))}
                                                                                placeholder="العدد"
                                                                                className="w-full px-3 py-2 border rounded"
                                                                            />
                                                                        </div>
                                                                    )}
                                                                    <input
                                                                        type="date"
                                                                        value={payment.startDate}
                                                                        onChange={(e) => updateCustomPayment(payment.id, 'startDate', e.target.value)}
                                                                        className="px-3 py-2 border rounded bg-white"
                                                                    />
                                                                    <div className="flex items-center justify-center">
                                                                        <button onClick={() => deleteCustomPayment(payment.id)} className="text-red-600 hover:text-red-800 text-xl font-bold">×</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>

                                            <div className="p-4 bg-indigo-50 rounded-lg border-2 border-indigo-200 space-y-3">
                                                <h3 className="font-bold text-lg">باقي الثمن (أقساط موحدة)</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                    <div>
                                                        <label className="block text-sm font-bold text-gray-700 mb-1">مدة الأقساط (سنوات)</label>
                                                        <input
                                                            type="number"
                                                            step="0.25"
                                                            value={customQuarterlyYears}
                                                            onChange={(e) => setCustomQuarterlyYears(parseFloat(e.target.value) || 0)}
                                                            className="w-full modern-input px-4 py-2"
                                                            placeholder="مثال: 8, 4, 0.25"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-bold text-gray-700 mb-1">تردد الأقساط المتبقية</label>
                                                        <select
                                                            value={customRemainingFrequency}
                                                            onChange={(e) => setCustomRemainingFrequency(parseInt(e.target.value))}
                                                            className="w-full modern-input px-4 py-2 bg-white"
                                                        >
                                                            <option value={4}>ربع سنوي (كل 3 شهور)</option>
                                                            <option value={2}>نصف سنوي (كل 6 شهور)</option>
                                                            <option value={1}>سنوي (كل 12 شهر)</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-bold text-gray-700 mb-1">تاريخ أول قسط (اختياري)</label>
                                                        <input
                                                            type="date"
                                                            value={customQuarterlyStartDate}
                                                            onChange={(e) => setCustomQuarterlyStartDate(e.target.value)}
                                                            className="w-full modern-input px-4 py-2 bg-white"
                                                            placeholder="تاريخ أول قسط"
                                                        />
                                                    </div>
                                                </div>
                                                <p className="text-xs text-gray-500 mt-1">
                                                    {customQuarterlyYears > 0 && `عدد الأقساط: ${Math.round(customQuarterlyYears * customRemainingFrequency)} قسط ${customRemainingFrequency === 4 ? 'ربع سنوي' : customRemainingFrequency === 2 ? 'نصف سنوي' : 'سنوي'}`}
                                                </p>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* خيار تقريب القسط - للمدير فقط */}
                                    {isAdmin && (
                                        <div className="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl p-4 border-2 border-amber-200 mt-6">
                                            <label className="block text-sm font-bold text-gray-700 mb-3">
                                                <span className="flex items-center gap-2"> 
                                                    <span>🎯</span> إعدادات تقريب القسط (للمدير) 
                                                </span>
                                            </label>
                                            <div className="mb-3 p-2 bg-green-100 rounded-lg border border-green-300">
                                                <p className="text-green-700 text-sm"> 
                                                    ✅ <strong>تلقائي:</strong> يتم تقريب جميع الأقساط للأعلى لأقرب 100 ج تلقائياً 
                                                </p>
                                            </div>
                                            <p className="text-sm text-gray-600 mb-2">تقريب إضافي (اختياري):</p>
                                            <div className="flex flex-wrap gap-3">
                                                <label className={`flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer transition-all ${roundingOption === 'none' ? 'bg-amber-500 text-white' : 'bg-white border-2 border-gray-300 hover:border-amber-400'}`}>
                                                    <input type="radio" name="rounding" value="none" checked={roundingOption === 'none'} onChange={(e) => setRoundingOption(e.target.value)} className="hidden" />
                                                    <span className="font-bold">بلا تقريب إضافي</span>
                                                </label>
                                                <label className={`flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer transition-all ${roundingOption === '500' ? 'bg-amber-500 text-white' : 'bg-white border-2 border-gray-300 hover:border-amber-400'}`}>
                                                    <input type="radio" name="rounding" value="500" checked={roundingOption === '500'} onChange={(e) => setRoundingOption(e.target.value)} className="hidden" />
                                                    <span className="font-bold">لأقرب 500 ج</span>
                                                </label>
                                                <label className={`flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer transition-all ${roundingOption === '1000' ? 'bg-amber-500 text-white' : 'bg-white border-2 border-gray-300 hover:border-amber-400'}`}>
                                                    <input type="radio" name="rounding" value="1000" checked={roundingOption === '1000'} onChange={(e) => setRoundingOption(e.target.value)} className="hidden" />
                                                    <span className="font-bold">لأقرب 1000 ج</span>
                                                </label>
                                                <label className={`flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer transition-all ${roundingOption === '100' ? 'bg-amber-500 text-white' : 'bg-white border-2 border-gray-300 hover:border-amber-400'}`}>
                                                    <input type="radio" name="rounding" value="100" checked={roundingOption === '100'} onChange={(e) => setRoundingOption(e.target.value)} className="hidden" />
                                                    <span className="font-bold">إلغاء الإضافي (بقاء 100 تلقائي)</span>
                                                </label>
                                            </div>
                                        </div>
                                    )}

                                    {/* Calculate Button */}
                                    <div className="mt-6 flex justify-center">
                                        <button onClick={calculateResults} className="btn-premium gradient-primary text-white text-2xl font-bold px-12 py-4 rounded-xl shadow-2xl shadow-red-500/50">
                                            حساب خطة السداد
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Base System Summary (for comparison) */}
                                {getSelectedProject()?.baseSystem && unitValue > 0 && selectedPattern !== 'custom' && (
                                    <div className="mb-6 p-4 bg-blue-50 rounded-lg border-2 border-gray-300 print-hidden">
                                        <div className="flex items-center justify-between mb-2">
                                            <h3 className="font-bold text-lg text-gray-800">📋 النظام الأساسي للمشروع</h3>
                                            <button onClick={() => { calculateResults(); setShowComparison(true); }} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm" > 
                                                📊 مقارنة 
                                            </button>
                                        </div>
                                        <div className="text-sm text-gray-700 space-y-1">
                                            <p><span className="font-bold">المقدم:</span> {getSelectedProject().baseSystem.downPaymentValue}{getSelectedProject().baseSystem.downPaymentIsPercentage ? '%' : ' ج'} ({formatCurrency(unitValue * (getSelectedProject().baseSystem.downPaymentIsPercentage ? getSelectedProject().baseSystem.downPaymentValue / 100 : 1) || getSelectedProject().baseSystem.downPaymentValue)})</p>
                                            <p><span className="font-bold">سنوات التقسيط:</span> {getSelectedProject().baseSystem.quarterlyYears} سنوات</p>
                                            <p><span className="font-bold">دفعات إضافية سنوية:</span> {getSelectedProject().baseSystem.annualPayments.length} | <span className="font-bold">نصف سنوية:</span> {getSelectedProject().baseSystem.semiannualPayments.length} | <span className="font-bold">ربع سنوية محددة:</span> {getSelectedProject().baseSystem.quarterlyPayments.length}</p>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Results Panel */}
                                {results && (
                                    <div id="print-area" className="glass-card p-6 rounded-xl shadow-2xl animate-fade-in">
                                        <div className="flex items-center justify-between mb-4 print-hidden">
                                            <div>
                                                <h2 className="text-2xl font-bold text-gray-800">✅ خطة السداد - {results.patternName}</h2>
                                            </div>
                                            <div className="flex gap-3">
                                                {baseSystemResults && (
                                                    <button onClick={() => setShowComparison(true)} className="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg">
                                                        📊 مقارنة متقدمة
                                                    </button>
                                                )}
                                                <button onClick={handlePrint} className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg flex items-center gap-2">
                                                    🖨️ طباعة
                                                </button>
                                            </div>
                                        </div>

                                        {/* Print Header */}
                                        <div className="print-only mb-6">
                                            <h2 className="text-2xl font-bold text-gray-800 text-center mb-4">خطة سداد الوحدة - {getSelectedProject()?.name}</h2>
                                            <div className="grid grid-cols-2 gap-4 text-lg border-b pb-4">
                                                <div><span className="font-bold">المشروع:</span> {getSelectedProject()?.name}</div>
                                                <div><span className="font-bold">نظام السداد:</span> {results.patternName}</div>
                                                <div><span className="font-bold">قيمة الوحدة:</span> {formatCurrency(unitValue)}</div>
                                                <div><span className="font-bold">قيمة الكاش (PV):</span> {formatCurrency(getSelectedProject()?.cashDiscountRate ? unitValue * (1 - getSelectedProject().cashDiscountRate / 100) : unitValue)}</div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4 text-lg pt-2">
                                                <div><span className="font-bold">رقم الوحدة/العميل:</span> {unitNumber || 'غير محدد'}</div>
                                                <div><span className="font-bold">مدة التقسيط:</span> {results.pattern !== 'custom' ? `${numberOfYears} سنوات (${results.schedule.filter(p => p.type.includes('قسط')).length} قسط)` : 'مخصص'}</div>
                                            </div>
                                        </div>

                                        {/* Main Summary Boxes */}
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            <div className="bg-white rounded-lg p-4 text-center shadow">
                                                <p className="text-sm text-gray-600 mb-1">المقدم</p>
                                                <p className="text-xl font-bold text-gray-800">{formatCurrency(results.downPayment)}</p>
                                            </div>
                                            <div className="bg-white rounded-lg p-4 text-center shadow">
                                                <p className="text-sm text-gray-600 mb-1">القسط الأول</p>
                                                <p className="text-xl font-bold text-red-600">
                                                    {formatCurrency(results.installmentAmount || results.baseInstallment || results.schedule.find(p => p.type.includes('قسط'))?.amount || 0)}
                                                </p>
                                            </div>
                                            <div className="bg-white rounded-lg p-4 text-center shadow">
                                                <p className="text-sm text-gray-600 mb-1">عدد الدفعات</p>
                                                <p className="text-xl font-bold text-gray-800">{results.schedule.length - 1}</p>
                                            </div>
                                            <div className="bg-white rounded-lg p-4 text-center shadow">
                                                <p className="text-sm text-gray-600 mb-1">الإجمالي المدفوع</p>
                                                <p className="text-xl font-bold text-green-600">{formatCurrency(results.summary.totalPaid)}</p>
                                            </div>
                                        </div>
                                        
                                        {/* Schedule Table */}
                                        <div className="mt-6 overflow-x-auto">
                                            <h3 className="text-lg font-bold text-gray-800 mb-3">جدول الدفعات المفصل</h3>
                                            <table className="min-w-full bg-white border-collapse border border-gray-200 shadow-md rounded-xl">
                                                <thead>
                                                    <tr className="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                                        <th className="py-3 px-6 text-right border-b border-gray-200">#</th>
                                                        <th className="py-3 px-6 text-right border-b border-gray-200">تاريخ الدفعة</th>
                                                        <th className="py-3 px-6 text-right border-b border-gray-200">نوع الدفعة</th>
                                                        <th className="py-3 px-6 text-right border-b border-gray-200">المبلغ (ج)</th>
                                                        {isAdmin && <th className="py-3 px-6 text-right border-b border-gray-200 print-hidden">PV</th>}
                                                        {isAdmin && <th className="py-3 px-6 text-right border-b border-gray-200 print-hidden">الخصم</th>}
                                                    </tr>
                                                </thead>
                                                <tbody className="text-gray-700 text-sm font-light">
                                                    {results.schedule.map((p, index) => (
                                                        <tr key={index} className={`border-b border-gray-200 hover:bg-gray-50 ${p.type === 'مقدم' ? 'bg-blue-50 font-bold' : ''}`}>
                                                            <td className="py-3 px-6 text-right whitespace-nowrap">{p.id}</td>
                                                            <td className="py-3 px-6 text-right whitespace-nowrap">{formatDate(p.date)}</td>
                                                            <td className="py-3 px-6 text-right whitespace-nowrap">{p.type}</td>
                                                            <td className="py-3 px-6 text-right whitespace-nowrap font-bold text-lg">{formatCurrency(p.amount)}</td>
                                                            {isAdmin && <td className="py-3 px-6 text-right whitespace-nowrap print-hidden">{formatCurrency(p.pv)}</td>}
                                                            {isAdmin && <td className="py-3 px-6 text-right whitespace-nowrap print-hidden">{formatCurrency(p.discount)}</td>}
                                                        </tr>
                                                    ))}
                                                    <tr className="bg-gray-200 font-bold text-base">
                                                        <td className="py-3 px-6 text-right" colSpan={isAdmin ? 3 : 2}>الإجمالي</td>
                                                        <td className="py-3 px-6 text-right text-green-700">{formatCurrency(results.summary.totalPaid)}</td>
                                                        {isAdmin && <td className="py-3 px-6 text-right print-hidden text-blue-700">{formatCurrency(results.summary.totalPV)}</td>}
                                                        {isAdmin && <td className="py-3 px-6 text-right print-hidden text-red-700">{formatCurrency(results.summary.totalDiscount)}</td>}
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>

                                        {/* Footer Print Info */}
                                        <div className="print-only mt-8">
                                            <div className="grid grid-cols-3 gap-4 border-t pt-4 text-sm">
                                                <div>
                                                    <p className="text-gray-600">القيمة الحالية (PV)</p>
                                                    <p className="font-bold text-blue-700">{formatCurrency(results.summary.totalPV)}</p>
                                                </div>
                                                <div>
                                                    <p className="text-gray-600">إجمالي الخصم</p>
                                                    <p className="font-bold text-red-700">{formatCurrency(results.summary.totalDiscount)}</p>
                                                </div>
                                                <div>
                                                    <p className="text-gray-600">معدل الفائدة الفعلي</p>
                                                    <p className="font-bold text-orange-700">{results.summary.effectiveInterestRate.toFixed(2)}%</p>
                                                </div>
                                            </div>
                                            
                                            <div className="mt-8 grid grid-cols-2 gap-8">
                                                <div className="text-center">
                                                    <div className="border-b border-dashed border-gray-400 h-10 mb-2"></div>
                                                    <p className="font-bold">توقيع العميل</p>
                                                </div>
                                                <div className="text-center">
                                                    <div className="border-b border-dashed border-gray-400 h-10 mb-2"></div>
                                                    <p className="font-bold">توقيع الشركة</p>
                                                </div>
                                            </div>
                                            <div className="text-center mt-8 text-sm text-gray-600">
                                                <p>شركة بيتا للتطوير العقاري - BETA SMART FINANCE</p>
                                                <p className="mt-1">هاتف: 19231 - info@betadevelopments.com</p>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* ADMIN ONLY: Technical Details */}
                                {isAdmin && results && (
                                    <div className="mt-4 p-4 bg-white rounded-lg shadow print-hidden animate-fade-in">
                                        <h3 className="font-bold text-gray-800 mb-2">🔍 تفاصيل التحقق (للمدير فقط)</h3>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                            <div>
                                                <p className="text-gray-600">قيمة الكاش (Target PV)</p>
                                                <p className="font-bold text-blue-700">{formatCurrency(results.verification.cashValue)}</p>
                                            </div>
                                            <div>
                                                <p className="text-gray-600">PV الجدول المحسوب</p>
                                                <p className="font-bold text-blue-700">{formatCurrency(results.verification.totalPV)}</p>
                                            </div>
                                            <div>
                                                <p className="text-gray-600">الفرق (PV Diff)</p>
                                                <p className="font-bold text-red-700">{formatCurrency(results.verification.difference)}</p>
                                            </div>
                                            <div>
                                                <p className="text-gray-600">نسبة الفرق المئوية</p>
                                                <p className="font-bold text-red-700">{results.verification.percentDiff.toFixed(5)}%</p>
                                            </div>
                                            <div>
                                                <p className="text-gray-600">حالة المطابقة</p>
                                                <p className={`font-bold ${results.verification.status.includes('مطابق') ? 'text-green-600' : 'text-red-600'}`}>{results.verification.status}</p>
                                            </div>
                                            <div>
                                                <p className="text-gray-600">الإجمالي المدفوع</p>
                                                <p className="font-bold text-green-700">{formatCurrency(results.summary.totalPaid)}</p>
                                            </div>
                                            <div>
                                                <p className="text-gray-600">الفرق الإجمالي</p>
                                                <p className="font-bold text-orange-700">
                                                    {formatCurrency(results.summary.totalPaid - (unitValue * (100 - (getSelectedProject()?.cashDiscountRate || 0)) / 100))}
                                                </p>
                                            </div>
                                            <div>
                                                <p className="text-gray-600">نسبة الزيادة الكلية</p>
                                                <p className="font-bold text-orange-700">
                                                    {((results.summary.totalPaid / (unitValue * (100 - (getSelectedProject()?.cashDiscountRate || 0)) / 100) - 1) * 100).toFixed(2)}%
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Enhanced Comparison Modal */}
                        <ComparisonModal />

                        {/* SQLite Database Management Panel - Admin Only */}
                        {isAdmin && (
                            <div className="mt-6 print-hidden animate-fade-in">
                                <div className="glass-card rounded-2xl p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                            🗄️ قاعدة البيانات SQLite
                                            {dbReady ? 
                                                <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">متصلة ✅</span> :
                                                <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full">جارٍ التحميل...</span>
                                            }
                                        </h3>
                                    </div>
                                    
                                    {/* Stats */}
                                    <div className="grid grid-cols-3 gap-3 mb-4">
                                        <div className="bg-blue-50 rounded-xl p-3 text-center">
                                            <p className="text-xs text-blue-600">المشاريع</p>
                                            <p className="text-xl font-bold text-blue-800">{dbStats.projectCount || 0}</p>
                                        </div>
                                        <div className="bg-green-50 rounded-xl p-3 text-center">
                                            <p className="text-xs text-green-600">العمليات الحسابية</p>
                                            <p className="text-xl font-bold text-green-800">{dbStats.calculationCount || 0}</p>
                                        </div>
                                        <div className="bg-purple-50 rounded-xl p-3 text-center">
                                            <p className="text-xs text-purple-600">آخر عملية</p>
                                            <p className="text-sm font-bold text-purple-800">{dbStats.lastCalculation || '—'}</p>
                                        </div>
                                    </div>

                                    {/* Actions */}
                                    <div className="flex flex-wrap gap-3">
                                        <button onClick={exportDB}
                                            className="btn-premium gradient-success text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2"
                                            disabled={!dbReady}>
                                            💾 تصدير قاعدة البيانات
                                        </button>
                                        <button onClick={importDB}
                                            className="btn-premium bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2"
                                            disabled={!dbReady}>
                                            📂 استيراد قاعدة بيانات
                                        </button>
                                        <button onClick={loadHistory}
                                            className="btn-premium bg-purple-600 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2"
                                            disabled={!dbReady}>
                                            📋 سجل العمليات ({dbStats.calculationCount || 0})
                                        </button>
                                        <button onClick={() => {
                                            if (confirm('⚠️ هل تريد مسح سجل العمليات الحسابية؟ لن يتم مسح المشاريع.')) {
                                                betaDB.clearHistory();
                                                setDbStats(betaDB.getStats());
                                                setCalcHistory([]);
                                                alert('✅ تم مسح السجل');
                                            }
                                        }}
                                            className="btn-premium bg-red-500 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2"
                                            disabled={!dbReady}>
                                            🗑️ مسح السجل
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Calculation History Modal */}
                        {showHistory && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 print-hidden"
                                 onClick={() => setShowHistory(false)}>
                                <div className="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[85vh] overflow-hidden animate-slide-in"
                                     onClick={e => e.stopPropagation()}>
                                    <div className="bg-gradient-to-r from-purple-700 to-purple-900 px-6 py-4 text-white flex items-center justify-between">
                                        <h3 className="text-lg font-bold">📋 سجل العمليات الحسابية</h3>
                                        <button onClick={() => setShowHistory(false)} className="text-white/80 hover:text-white text-2xl">✕</button>
                                    </div>
                                    <div className="overflow-y-auto max-h-[70vh] p-4">
                                        {calcHistory.length === 0 ? (
                                            <div className="text-center py-12 text-gray-400">
                                                <p className="text-4xl mb-3">📭</p>
                                                <p className="text-lg">لا توجد عمليات محفوظة</p>
                                            </div>
                                        ) : (
                                            <table className="w-full text-sm border-collapse">
                                                <thead>
                                                    <tr className="bg-gray-100 text-gray-600">
                                                        <th className="py-2 px-3 text-right border-b">#</th>
                                                        <th className="py-2 px-3 text-right border-b">التاريخ</th>
                                                        <th className="py-2 px-3 text-right border-b">المشروع</th>
                                                        <th className="py-2 px-3 text-right border-b">الوحدة</th>
                                                        <th className="py-2 px-3 text-right border-b">قيمة الوحدة</th>
                                                        <th className="py-2 px-3 text-right border-b">النظام</th>
                                                        <th className="py-2 px-3 text-right border-b">التردد</th>
                                                        <th className="py-2 px-3 text-right border-b">الإجمالي</th>
                                                        <th className="py-2 px-3 text-right border-b">PV</th>
                                                        <th className="py-2 px-3 text-center border-b">حذف</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {calcHistory.map((calc, idx) => {
                                                        const proj = projects.find(p => p.id === calc.project_id);
                                                        const freqLabel = calc.frequency === 4 ? 'ربع سنوي' : calc.frequency === 2 ? 'نصف سنوي' : calc.frequency === 1 ? 'سنوي' : calc.frequency;
                                                        const patternLabel = calc.pattern === 'equal' ? 'موحد' : calc.pattern === 'decreasing' ? 'متناقص' : calc.pattern === 'graduated' ? 'متزايد' : calc.pattern === 'custom' ? 'مخصص' : calc.pattern;
                                                        return (
                                                            <tr key={calc.id} className="border-b hover:bg-gray-50">
                                                                <td className="py-2 px-3">{idx + 1}</td>
                                                                <td className="py-2 px-3 text-xs">{calc.created_at}</td>
                                                                <td className="py-2 px-3 font-bold">{proj?.name || calc.project_id}</td>
                                                                <td className="py-2 px-3">{calc.unit_number || '—'}</td>
                                                                <td className="py-2 px-3">{Number(calc.unit_value).toLocaleString('ar-EG')} ج</td>
                                                                <td className="py-2 px-3">{patternLabel}</td>
                                                                <td className="py-2 px-3">{freqLabel}</td>
                                                                <td className="py-2 px-3 font-bold text-green-700">{Number(calc.total_paid).toLocaleString('ar-EG')} ج</td>
                                                                <td className="py-2 px-3 text-blue-700">{Number(calc.total_pv).toLocaleString('ar-EG')} ج</td>
                                                                <td className="py-2 px-3 text-center">
                                                                    <button onClick={() => {
                                                                        betaDB.deleteCalculation(calc.id);
                                                                        setCalcHistory(calcHistory.filter(c => c.id !== calc.id));
                                                                        setDbStats(betaDB.getStats());
                                                                    }} className="text-red-500 hover:text-red-700 text-lg">🗑️</button>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Footer */}
                        <div className="text-center text-gray-600 text-sm mt-8 pb-8 print-hidden">
                            <p className="font-bold text-red-600 text-lg">شركة بيتا للتطوير العقاري</p>
                            <p className="mt-1">BETA SMART FINANCE | نظام التقسيط المرن - دقة عالية - AMR ALTAMAWI</p>
                            <p className="mt-1 text-xs text-gray-400">
                                {dbReady ? '🗄️ SQLite Database Active' : '💾 localStorage Mode'}
                                {dbStats.calculationCount > 0 && ` | ${dbStats.calculationCount} عملية محفوظة`}
                            </p>
                            <p className="mt-2">© 2025 جميع الحقوق محفوظة</p>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<BetaSmartFinance />, document.getElementById('root'));
    </script>
</body>
</html>
